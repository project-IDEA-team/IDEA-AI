from typing import Dict, List, Any
import logging
from app.models.expert_type import ExpertType
from app.service.experts.base_expert import BaseExpert
from app.service.openai_client import get_client
from app.service.public_api.api_manager import ApiManager

logger = logging.getLogger(__name__)

class StartupExpert(BaseExpert):
    """
    ì°½ì—… ì „ë¬¸ê°€ AI í´ë˜ìŠ¤
    ì¥ì• ì¸ ì°½ì—… ì§€ì›, ì‚¬ì—… ìš´ì˜, ì°½ì—… êµìœ¡ ë“±ì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
    """
    
    def __init__(self):
        super().__init__(ExpertType.STARTUP)
        self.client = get_client()
        self.api_manager = ApiManager()
    
    def _get_system_prompt(self) -> str:
        return """
        ë„ˆëŠ” ì¥ì• ì¸ ì°½ì—… ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤. 
        ì¥ì• ì¸ ì°½ì—… ì§€ì›, ì‚¬ì—… ìš´ì˜, ì°½ì—… êµìœ¡ ë“±ì— ëŒ€í•œ ì •í™•í•˜ê³  ìœ ìš©í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.
        
        ì œê³µí•  ì •ë³´ ë²”ìœ„:
        - ì¥ì• ì¸ ì°½ì—… ì§€ì› ì •ì±… ë° ì œë„
        - ì¥ì• ì¸ ì°½ì—… ìê¸ˆ ì§€ì› ë° ìœµì
        - ì¥ì• ì¸ ì í•© ì°½ì—… ì•„ì´í…œ
        - ì°½ì—… êµìœ¡ ë° ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨
        - ì¥ì• ì¸ê¸°ì—… ì¸ì¦ ë° í˜œíƒ
        - ì‚¬íšŒì ê¸°ì—…, í˜‘ë™ì¡°í•© ë“± ì‚¬íšŒì  ê²½ì œ ì°½ì—…
        - ì—…ì¢…ë³„ ì°½ì—… ì ˆì°¨ ë° í•„ìš” ì„œë¥˜
        - ì„±ê³µ ì‚¬ë¡€ ë° ì‹¤íŒ¨ ì‚¬ë¡€ ë¶„ì„
        
        ì‘ë‹µ ìŠ¤íƒ€ì¼:
        1. í•­ìƒ ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”. ì°½ì—…ì˜ ê°€ëŠ¥ì„±ì„ ê°•ì¡°í•˜ëŠ” í‘œí˜„ì„ í¬í•¨í•˜ì„¸ìš”.
        2. ì‘ë‹µ ì‹œì‘ ë¶€ë¶„ì— ì§§ì€ ê³µê°/ê²©ë ¤ ë©˜íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”. (ì˜ˆ: "ì°½ì—…ì— ê´€ì‹¬ì„ ê°€ì§€ê³  ê³„ì‹œëŠ”êµ°ìš”. í•¨ê»˜ ì¢‹ì€ ì •ë³´ë¥¼ ì°¾ì•„ë³´ê² ìŠµë‹ˆë‹¤.")
        3. ì°½ì—… ì •ë³´ë¥¼ ì •í™•í•˜ê³  ì‹¤ìš©ì ìœ¼ë¡œ ì œê³µí•˜ë˜, í˜„ì‹¤ì ì¸ ì–´ë ¤ì›€ê³¼ ê·¹ë³µ ë°©ë²•ë„ í•¨ê»˜ ì•ˆë‚´í•˜ì„¸ìš”.
        4. ì¥ì•  íŠ¹ì„±ì„ ê³ ë ¤í•œ ë§ì¶¤í˜• ì°½ì—… ì•„ì´í…œì´ë‚˜ ìš´ì˜ ë°©ì‹ì„ ì œì•ˆí•˜ì„¸ìš”.
        5. ìê¸ˆ ì§€ì›, ì„¸ì œ í˜œíƒ ë“± ì‹¤ì§ˆì ì¸ ì§€ì› ì •ë³´ë¥¼ ìƒì„¸íˆ ì•ˆë‚´í•˜ì„¸ìš”.
        6. ì‹ ì²­ ë°©ë²•, í•„ìš” ì„œë¥˜, ë‹´ë‹¹ ê¸°ê´€ ë“± êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ í¬í•¨í•˜ì„¸ìš”.
        
        ì •ë³´ ì¹´ë“œ:
        1. ëª¨ë“  ì‘ë‹µì—ëŠ” ë°˜ë“œì‹œ ê´€ë ¨ ì°½ì—… ì •ë³´ ì¹´ë“œë¥¼ í¬í•¨í•˜ì„¸ìš”.
        2. ì¹´ë“œì—ëŠ” ì§€ì› í”„ë¡œê·¸ë¨, ìê¸ˆ ì§€ì› ì œë„, ì°½ì—… êµìœ¡ ë“± í•µì‹¬ ì •ë³´ë¥¼ ë‹´ìœ¼ì„¸ìš”.
        
        ì‚¬ìš©ìì—ê²Œ ì‹¤ì§ˆì ì¸ ì°½ì—… ì •ë³´ì™€ ê¸°íšŒë¥¼ ì œê³µí•˜ë©´ì„œë„, ì„±ê³µì ì¸ ì°½ì—…ì— ëŒ€í•œ ìì‹ ê°ê³¼ í¬ë§ì„ í•¨ê»˜ ì „ë‹¬í•˜ì„¸ìš”.
        """
    
    def _get_tools(self) -> List[Dict[str, Any]]:
        return [
            {
                "type": "function",
                "function": {
                    "name": "search_startup_information",
                    "description": "ì¥ì• ì¸ ì°½ì—… ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "keywords": {
                                "type": "array",
                                "items": {
                                    "type": "string"
                                },
                                "description": "ê²€ìƒ‰ í‚¤ì›Œë“œ ëª©ë¡"
                            },
                            "startup_type": {
                                "type": "string",
                                "description": "ì°½ì—… ìœ í˜•"
                            },
                            "support_type": {
                                "type": "string",
                                "description": "ì§€ì› ìœ í˜•"
                            },
                            "region": {
                                "type": "string",
                                "description": "ì§€ì—­ ì •ë³´"
                            }
                        },
                        "required": ["keywords"]
                    }
                }
            }
        ]
    
    async def search_startup_information(self, keywords: List[str], startup_type: str = None, support_type: str = None, region: str = None) -> List[Dict[str, Any]]:
        """
        í‚¤ì›Œë“œ, ì°½ì—… ìœ í˜•, ì§€ì› ìœ í˜•, ì§€ì—­ ë“±ì„ ê¸°ë°˜ìœ¼ë¡œ ì°½ì—… ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
        
        Args:
            keywords: ê²€ìƒ‰ í‚¤ì›Œë“œ ëª©ë¡
            startup_type: ì°½ì—… ìœ í˜•
            support_type: ì§€ì› ìœ í˜•
            region: ì§€ì—­ ì •ë³´
            
        Returns:
            ê²€ìƒ‰ëœ ì°½ì—… ì •ë³´ ì¹´ë“œ ëª©ë¡
        """
        try:
            # ApiManagerë¥¼ í†µí•´ ê³µê³µë°ì´í„° APIì—ì„œ ì°½ì—… ì •ë³´ ê²€ìƒ‰
            startup_cards = await self.api_manager.search_by_keywords(keywords, "ì°½ì—…")
            
            # ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë°˜í™˜
            if startup_cards:
                return startup_cards
                
            # ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš° ë°±ì—… ë°ì´í„° í™œìš©
            # 2ì°¨ ì‹œë„: ìê¸ˆ ì§€ì› ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ì°½ì—… ìê¸ˆ ì§€ì› ì •ë³´ ì œê³µ
            if any(kw in ["ìê¸ˆ", "ìœµì", "ëŒ€ì¶œ", "ì§€ì›ê¸ˆ", "íˆ¬ì"] for kw in keywords):
                return [{
                    "id": "startup-fund-1",
                    "title": "ì¥ì• ì¸ ì°½ì—… ìê¸ˆ ì§€ì› ì œë„",
                    "subtitle": "ì°½ì—… ìê¸ˆ",
                    "summary": "ì¥ì• ì¸ ì°½ì—…ìë¥¼ ìœ„í•œ ë‹¤ì–‘í•œ ìê¸ˆ ì§€ì› ë° ìœµì ì œë„",
                    "type": "startup",
                    "details": (
                        "ì¥ì• ì¸ ì°½ì—…ìë¥¼ ìœ„í•œ ë‹¤ì–‘í•œ ìê¸ˆ ì§€ì› ì œë„ì…ë‹ˆë‹¤.\n\n"
                        "1. ì¥ì• ì¸ê¸°ì—…ì¢…í•©ì§€ì›ì„¼í„° ì°½ì—… ì§€ì›ê¸ˆ\n"
                        "   - ì§€ì›ê·œëª¨: ìµœëŒ€ 7ì²œë§Œì›\n"
                        "   - ëŒ€ìƒ: ì°½ì—… ì˜ˆì •ì´ê±°ë‚˜ 3ë…„ ì´ë‚´ ì¥ì• ì¸ê¸°ì—…\n"
                        "   - ìš©ë„: ì‹œì„¤ë¹„, ì¥ë¹„êµ¬ì…ë¹„, ê¸°ìˆ ê°œë°œë¹„ ë“±\n"
                        "   - ì‹ ì²­: í•œêµ­ì¥ì• ì¸ê¸°ì—…ì¢…í•©ì§€ì›ì„¼í„°\n\n"
                        "2. ì¥ì• ì¸ ì°½ì—…ì í¬ ì§€ì›ì‚¬ì—…\n"
                        "   - ì§€ì›ê·œëª¨: ìµœëŒ€ 1ì–µì› í•œë„ ì„ì°¨ë³´ì¦ê¸ˆ ì§€ì›\n"
                        "   - ì¡°ê±´: 5ë…„ ë¶„í• ìƒí™˜, ì—° 1~2% ì´ì\n"
                        "   - ì‹ ì²­: í•œêµ­ì¥ì• ì¸ê°œë°œì›\n\n"
                        "3. ì¥ì• ì¸ ì „ìš© ì°½ì—…ìê¸ˆ ìœµì\n"
                        "   - ì§€ì›ê·œëª¨: ìµœëŒ€ 1ì–µ 2ì²œë§Œì›\n"
                        "   - ì¡°ê±´: ìµœëŒ€ 7ë…„ ëŒ€ì¶œ, ìš°ëŒ€ê¸ˆë¦¬ ì ìš©\n"
                        "   - ì‹ ì²­: ì†Œìƒê³µì¸ì‹œì¥ì§„í¥ê³µë‹¨\n\n"
                        "4. ì‚¬íšŒì ê¸°ì—…ê°€ ìœ¡ì„±ì‚¬ì—… ì°½ì—… ì§€ì›ê¸ˆ\n"
                        "   - ì§€ì›ê·œëª¨: íŒ€ë‹¹ 5ì²œë§Œì› ë‚´ì™¸\n"
                        "   - ì‚¬íšŒì  ëª©ì  ì‹¤í˜„ ì°½ì—… ì•„ì´í…œ ë³´ìœ ì ëŒ€ìƒ\n"
                        "   - ì‹ ì²­: í•œêµ­ì‚¬íšŒì ê¸°ì—…ì§„í¥ì›"
                    ),
                    "source": {
                        "url": "https://www.debc.or.kr",
                        "name": "ì¥ì• ì¸ê¸°ì—…ì¢…í•©ì§€ì›ì„¼í„°",
                        "phone": "02-2181-6500"
                    },
                    "buttons": [
                        {"type": "link", "label": "ìê¸ˆì§€ì› ì•ˆë‚´", "value": "https://www.debc.or.kr/support/start-up"},
                        {"type": "tel", "label": "ë¬¸ì˜ì „í™”", "value": "02-2181-6500"}
                    ]
                }]
            
            # 3ì°¨ ì‹œë„: êµìœ¡/ì»¨ì„¤íŒ… ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ì°½ì—… êµìœ¡ ì •ë³´ ì œê³µ
            if any(kw in ["êµìœ¡", "ì»¨ì„¤íŒ…", "ë©˜í† ë§", "ìƒë‹´", "ì½”ì¹­"] for kw in keywords):
                return [{
                    "id": "startup-education-1",
                    "title": "ì¥ì• ì¸ ì°½ì—… êµìœ¡ ë° ì»¨ì„¤íŒ…",
                    "subtitle": "ì°½ì—… êµìœ¡",
                    "summary": "ì¥ì• ì¸ ì˜ˆë¹„ì°½ì—…ì ë° ê¸°ì°½ì—…ìë¥¼ ìœ„í•œ êµìœ¡ ë° ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨",
                    "type": "startup",
                    "details": (
                        "ì¥ì• ì¸ ì°½ì—…ìë¥¼ ìœ„í•œ êµìœ¡ ë° ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.\n\n"
                        "1. ì¥ì• ì¸ ë§ì¶¤í˜• ì°½ì—…êµìœ¡\n"
                        "   - ë‚´ìš©: ì°½ì—… ê¸°ì´ˆ, ìƒê¶Œë¶„ì„, ë§ˆì¼€íŒ…, ì„¸ë¬´/íšŒê³„, ì˜¨ë¼ì¸ ì°½ì—… ë“±\n"
                        "   - ëŒ€ìƒ: ì˜ˆë¹„ì°½ì—…ì ë° ì—…ì¢…ì „í™˜ í¬ë§ì\n"
                        "   - ë¹„ìš©: ë¬´ë£Œ\n"
                        "   - ì‹ ì²­: ì¥ì• ì¸ê¸°ì—…ì¢…í•©ì§€ì›ì„¼í„°\n\n"
                        "2. ì°½ì—… ë©˜í† ë§ í”„ë¡œê·¸ë¨\n"
                        "   - ë‚´ìš©: ë¶„ì•¼ë³„ ì „ë¬¸ê°€ì™€ 1:1 ë©˜í† ë§\n"
                        "   - ëŒ€ìƒ: ì°½ì—… 1ë…„ ì´ë‚´ ì¥ì• ì¸ê¸°ì—…\n"
                        "   - ë¶„ì•¼: ë§ˆì¼€íŒ…, ì¬ë¬´, ìƒí’ˆê°œë°œ, ì˜¨ë¼ì¸ íŒë¡œ ë“±\n"
                        "   - ì‹ ì²­: ì¥ì• ì¸ê¸°ì—…ì¢…í•©ì§€ì›ì„¼í„°\n\n"
                        "3. ì¥ì• ì¸ ì°½ì—… ì»¨ì„¤íŒ…\n"
                        "   - ë‚´ìš©: ì‚¬ì—…ê³„íš ìˆ˜ë¦½, ì…ì§€ì„ ì •, í–‰ì •ì ˆì°¨ ë“± ë§ì¶¤ ì»¨ì„¤íŒ…\n"
                        "   - ë¹„ìš©: ë¬´ë£Œ~ì¼ë¶€ ìë¶€ë‹´\n"
                        "   - ì‹ ì²­: ì†Œìƒê³µì¸ì‹œì¥ì§„í¥ê³µë‹¨\n\n"
                        "4. ì˜¨ë¼ì¸ ì°½ì—… ê°•ì¢Œ\n"
                        "   - ë‚´ìš©: ì°½ì—… ì „ ê³¼ì • ì˜¨ë¼ì¸ ê°•ì˜\n"
                        "   - ëŒ€ìƒ: ì œí•œ ì—†ìŒ\n"
                        "   - ì ‘ê·¼: K-ìŠ¤íƒ€íŠ¸ì—… í™ˆí˜ì´ì§€"
                    ),
                    "source": {
                        "url": "https://www.debc.or.kr",
                        "name": "ì¥ì• ì¸ê¸°ì—…ì¢…í•©ì§€ì›ì„¼í„°",
                        "phone": "02-2181-6500"
                    },
                    "buttons": [
                        {"type": "link", "label": "êµìœ¡ í”„ë¡œê·¸ë¨", "value": "https://www.debc.or.kr/education"},
                        {"type": "tel", "label": "ë¬¸ì˜ì „í™”", "value": "02-2181-6500"}
                    ]
                }]
            
            # ì‚¬íšŒì ê¸°ì—… ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ì‚¬íšŒì ê¸°ì—… ì°½ì—… ì •ë³´ ì œê³µ
            if any(kw in ["ì‚¬íšŒì ê¸°ì—…", "í˜‘ë™ì¡°í•©", "ì‚¬íšŒì ê²½ì œ", "ì†Œì…œ", "ì†Œì…œë²¤ì²˜"] for kw in keywords):
                return [{
                    "id": "social-enterprise-1",
                    "title": "ì¥ì• ì¸ ì‚¬íšŒì ê¸°ì—… ì°½ì—… ì§€ì›",
                    "subtitle": "ì‚¬íšŒì ê¸°ì—…",
                    "summary": "ì‚¬íšŒì  ê°€ì¹˜ì™€ ê²½ì œì  ê°€ì¹˜ë¥¼ ë™ì‹œì— ì¶”êµ¬í•˜ëŠ” ì‚¬íšŒì ê¸°ì—… ì°½ì—… ì •ë³´",
                    "type": "startup",
                    "details": (
                        "ì¥ì• ì¸ì´ ì„¤ë¦½í•˜ëŠ” ì‚¬íšŒì ê¸°ì—…ì— ëŒ€í•œ ì§€ì› ì •ë³´ì…ë‹ˆë‹¤.\n\n"
                        "1. ì‚¬íšŒì ê¸°ì—…ì´ë€?\n"
                        "   - ì·¨ì•½ê³„ì¸µì—ê²Œ ì¼ìë¦¬ë‚˜ ì‚¬íšŒì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ë©° ì‚¬íšŒì  ëª©ì ì„ ì¶”êµ¬í•˜ëŠ” ê¸°ì—…\n"
                        "   - ì˜ì—…í™œë™ì„ í†µí•œ ìˆ˜ìµ ì°½ì¶œê³¼ ì‚¬íšŒì  ê°€ì¹˜ ì‹¤í˜„ì„ ë™ì‹œì— ì¶”êµ¬\n\n"
                        "2. ì¥ì• ì¸ ì‚¬íšŒì ê¸°ì—… ì¸ì¦ í˜œíƒ\n"
                        "   - ì¸ê±´ë¹„ ì§€ì›: ìµœëŒ€ 5ë…„ê°„ ì¸ê±´ë¹„ ì¼ë¶€ ì§€ì›\n"
                        "   - ê²½ì˜ì§€ì›: ì „ë¬¸ ì»¨ì„¤íŒ…, í™ë³´, íŒë¡œ ì§€ì›\n"
                        "   - ì„¸ì œ í˜œíƒ: ë²•ì¸ì„¸, ì†Œë“ì„¸, ì·¨ë“ì„¸ ë“± ê°ë©´\n"
                        "   - ê³µê³µì¡°ë‹¬ ìš°ëŒ€: ê³µê³µê¸°ê´€ ìš°ì„ êµ¬ë§¤ ëŒ€ìƒ\n\n"
                        "3. ì‚¬íšŒì ê¸°ì—…ê°€ ìœ¡ì„±ì‚¬ì—…\n"
                        "   - ë‚´ìš©: ì°½ì—…ë¹„ìš©, ë©˜í† ë§, ì‚¬ì—…í™” ì§€ì› ë“±\n"
                        "   - ëŒ€ìƒ: ì‚¬íšŒë¬¸ì œ í•´ê²° ì•„ì´ë””ì–´ë¥¼ ê°€ì§„ (ì˜ˆë¹„)ì°½ì—…ì\n"
                        "   - ì§€ì›ê¸ˆ: íŒ€ë‹¹ 5ì²œë§Œì› ë‚´ì™¸\n"
                        "   - ì‹ ì²­: í•œêµ­ì‚¬íšŒì ê¸°ì—…ì§„í¥ì›\n\n"
                        "4. ì‚¬íšŒì ê¸°ì—… ì¸ì¦ ì ˆì°¨\n"
                        "   - ì˜ˆë¹„ì‚¬íšŒì ê¸°ì—… ì§€ì • â†’ ì‚¬íšŒì ê¸°ì—… ì¸ì¦ ì‹ ì²­ â†’ ì‹¬ì‚¬ ë° ì¸ì¦"
                    ),
                    "source": {
                        "url": "https://www.socialenterprise.or.kr",
                        "name": "í•œêµ­ì‚¬íšŒì ê¸°ì—…ì§„í¥ì›",
                        "phone": "031-697-7700"
                    },
                    "buttons": [
                        {"type": "link", "label": "ì‚¬íšŒì ê¸°ì—… ì•ˆë‚´", "value": "https://www.socialenterprise.or.kr"},
                        {"type": "tel", "label": "ë¬¸ì˜ì „í™”", "value": "031-697-7700"}
                    ]
                }]
            
            # ìµœí›„ ë°©ì•ˆ: ê¸°ë³¸ ì¥ì• ì¸ ì°½ì—… ì •ë³´ ì œê³µ
            return [{
                "id": "startup-info-1",
                "title": "ì¥ì• ì¸ ì°½ì—… ì§€ì› ì¢…í•© ì•ˆë‚´",
                "subtitle": "ì°½ì—… ì§€ì›",
                "summary": "ì¥ì• ì¸ì„ ìœ„í•œ ë‹¤ì–‘í•œ ì°½ì—… ì§€ì› ì œë„ ë° ì„œë¹„ìŠ¤ ì•ˆë‚´",
                "type": "startup",
                "details": (
                    "ì¥ì• ì¸ ì°½ì—…ìë¥¼ ìœ„í•œ ì£¼ìš” ì§€ì› ì œë„ ë° ì„œë¹„ìŠ¤ ì•ˆë‚´ì…ë‹ˆë‹¤.\n\n"
                    "ìê¸ˆ ì§€ì›:\n"
                    "- ì¥ì• ì¸ ì „ìš© ì •ì±…ìê¸ˆ ìœµì\n"
                    "- ì°½ì—…ìê¸ˆ ì§€ì› ë° ë³´ì¡°ê¸ˆ\n"
                    "- ì í¬ ì„ì°¨ë³´ì¦ê¸ˆ ì§€ì›\n\n"
                    "êµìœ¡ ë° ì»¨ì„¤íŒ…:\n"
                    "- ì°½ì—… ê¸°ì´ˆ êµìœ¡ í”„ë¡œê·¸ë¨\n"
                    "- ì „ë¬¸ ë©˜í† ë§ ë° ì»¨ì„¤íŒ…\n"
                    "- ì—…ì¢…ë³„ ì „ë¬¸ êµìœ¡\n\n"
                    "íŒë¡œ ì§€ì›:\n"
                    "- ì¥ì• ì¸ê¸°ì—… ì œí’ˆ ê³µê³µêµ¬ë§¤ ì§€ì›\n"
                    "- ì˜¨ë¼ì¸ íŒë¡œ ì§€ì›\n"
                    "- ì „ì‹œíšŒ ë° ë°•ëŒíšŒ ì°¸ê°€ ì§€ì›\n\n"
                    "ì¸ì¦ ë° í˜œíƒ:\n"
                    "- ì¥ì• ì¸ê¸°ì—… í™•ì¸ì œë„\n"
                    "- ì‚¬íšŒì ê¸°ì—… ì¸ì¦\n"
                    "- ì„¸ì œ í˜œíƒ ë° ì •ì±… ìš°ëŒ€"
                ),
                "source": {
                    "url": "https://www.debc.or.kr",
                    "name": "ì¥ì• ì¸ê¸°ì—…ì¢…í•©ì§€ì›ì„¼í„°",
                    "phone": "02-2181-6500"
                },
                "buttons": [
                    {"type": "link", "label": "ìì„¸íˆ ë³´ê¸°", "value": "https://www.debc.or.kr"},
                    {"type": "tel", "label": "ì°½ì—…ìƒë‹´", "value": "02-2181-6500"}
                ]
            }]
            
        except Exception as e:
            logger.error(f"ì°½ì—… ì •ë³´ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            # ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë°ì´í„° ë°˜í™˜
            return [{
                "id": "startup-error",
                "title": "ì¥ì• ì¸ ì°½ì—… ì •ë³´ ì•ˆë‚´",
                "subtitle": "ì°½ì—… ì •ë³´",
                "summary": "ì¥ì• ì¸ì„ ìœ„í•œ ì£¼ìš” ì°½ì—… ì§€ì› ì œë„ ì•ˆë‚´",
                "type": "startup",
                "details": (
                    "ì¥ì• ì¸ì„ ìœ„í•œ ë‹¤ì–‘í•œ ì°½ì—… ì§€ì› ì œë„ê°€ ìˆìŠµë‹ˆë‹¤:\n"
                    "- ì°½ì—… ìê¸ˆ ì§€ì› ë° ìœµì\n"
                    "- ì°½ì—… êµìœ¡ ë° ë©˜í† ë§\n"
                    "- ì¥ì• ì¸ê¸°ì—… íŒë¡œ ì§€ì›\n"
                    "- ì‚¬íšŒì ê¸°ì—… ì§€ì›\n"
                    "- ì°½ì—… ì»¨ì„¤íŒ…\n\n"
                    "ìì„¸í•œ ë‚´ìš©ì€ ì¥ì• ì¸ê¸°ì—…ì¢…í•©ì§€ì›ì„¼í„°ì— ë¬¸ì˜í•˜ì„¸ìš”."
                ),
                "source": {
                    "url": "https://www.debc.or.kr",
                    "name": "ì¥ì• ì¸ê¸°ì—…ì¢…í•©ì§€ì›ì„¼í„°",
                    "phone": "02-2181-6500"
                },
                "buttons": [
                    {"type": "link", "label": "ì°½ì—…ì§€ì› ì•ˆë‚´", "value": "https://www.debc.or.kr"},
                    {"type": "tel", "label": "ì°½ì—…ìƒë‹´", "value": "02-2181-6500"}
                ]
            }]
    
    async def process_query(self, query: str, keywords: List[str] = None, conversation_history: List[Dict[str, str]] = None) -> Dict[str, Any]:
        """
        ì‚¬ìš©ì ì¿¼ë¦¬ë¥¼ ì²˜ë¦¬í•˜ê³  ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        
        Args:
            query: ì‚¬ìš©ì ì¿¼ë¦¬
            keywords: ìŠˆí¼ë°”ì´ì €ê°€ ì¶”ì¶œí•œ í‚¤ì›Œë“œ ëª©ë¡
            conversation_history: ì´ì „ ëŒ€í™” ë‚´ìš©
            
        Returns:
            ì‘ë‹µ ë° ì°½ì—… ì •ë³´ ì¹´ë“œ ì •ë³´
        """
        try:
            # ëŒ€í™” ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
            if conversation_history is None:
                conversation_history = []
                
            # í‚¤ì›Œë“œê°€ ì—†ëŠ” ê²½ìš° ì¿¼ë¦¬ì—ì„œ ì¶”ì¶œ
            if not keywords:
                extraction_response = await self.client.chat.completions.create(
                    model="gpt-4.1-mini",
                    messages=[
                        {"role": "system", "content": "ì‚¬ìš©ìì˜ ì§ˆë¬¸ì—ì„œ ì¥ì• ì¸ ì°½ì—… ì •ë³´ ê²€ìƒ‰ì— í•„ìš”í•œ í•µì‹¬ í‚¤ì›Œë“œë¥¼ 5ê°œ ì´ë‚´ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”."},
                        {"role": "user", "content": query}
                    ],
                    temperature=0.3
                )
                
                import json
                # ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²˜ë¦¬
                try:
                    keywords_data = json.loads(extraction_response.choices[0].message.content)
                    keywords = keywords_data.get("keywords", [])
                except json.JSONDecodeError:
                    # ì¼ë°˜ í…ìŠ¤íŠ¸ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œë„
                    content = extraction_response.choices[0].message.content
                    possible_keywords = [k.strip() for k in content.split(',')]
                    keywords = [k for k in possible_keywords if k]
            
            # ì°½ì—… ì •ë³´ ê²€ìƒ‰
            startup_cards = await self.search_startup_information(keywords)
            
            # ê²€ìƒ‰ ê²°ê³¼ ê¸°ë°˜ ì‘ë‹µ ìƒì„±
            service_titles = ", ".join([card["title"] for card in startup_cards[:3]])
            
            # ëŒ€í™” ì´ë ¥ì„ LLM ë©”ì‹œì§€ë¡œ ë³€í™˜
            messages = [{"role": "system", "content": self._get_system_prompt()}]
            
            # ì´ì „ ëŒ€í™” ë‚´ìš©ì´ ìˆìœ¼ë©´ ë©”ì‹œì§€ì— ì¶”ê°€
            if conversation_history:
                for msg in conversation_history:
                    role = msg.get("role", "user")
                    content = msg.get("content", "")
                    if content.strip():  # ë‚´ìš©ì´ ìˆëŠ” ë©”ì‹œì§€ë§Œ ì¶”ê°€
                        messages.append({"role": role, "content": content})
            
            # ë§ˆì§€ë§‰ ì§ˆë¬¸ê³¼ ì°½ì—… ì •ë³´ í¬í•¨
            messages.append({
                "role": "user", 
                "content": f"ë‹¤ìŒ ì§ˆë¬¸ì— ëŒ€í•´ ê´€ë ¨ ì°½ì—… ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”. ê´€ë ¨ ì„œë¹„ìŠ¤: {service_titles}\n\nì§ˆë¬¸: {query}"
            })
            
            response = await self.client.chat.completions.create(
                model="gpt-4.1-mini",
                messages=messages,
                temperature=0.7
            )
            
            answer = response.choices[0].message.content
            
            return {
                "answer": answer,
                "cards": startup_cards
            }
            
        except Exception as e:
            logger.error(f"ì°½ì—… ì „ë¬¸ê°€ ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return {
                "answer": "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì°½ì—… ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
                "cards": []
            }
    
    def _get_description(self) -> str:
        return "ì°½ì—… ìê¸ˆ, êµìœ¡, ì‚¬íšŒì ê¸°ì—… ì§€ì› ì •ë³´ ì œê³µ"
    
    def _get_icon(self) -> str:
        return "ğŸš€"

async def startup_response(query: str, keywords: List[str] = None, conversation_history=None) -> tuple:
    """
    ì°½ì—… ì „ë¬¸ê°€ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        query: ì‚¬ìš©ì ì¿¼ë¦¬
        keywords: í‚¤ì›Œë“œ ëª©ë¡
        conversation_history: ì´ì „ ëŒ€í™” ë‚´ìš©
        
    Returns:
        ì‘ë‹µ í…ìŠ¤íŠ¸ì™€ ì°½ì—… ì •ë³´ ì¹´ë“œ ëª©ë¡
    """
    expert = StartupExpert()
    response = await expert.process_query(query, keywords, conversation_history)
    return response["answer"], response["cards"] 