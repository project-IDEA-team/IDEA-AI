from typing import Dict, List, Any
import logging
from app.models.expert_type import ExpertType
from app.service.experts.base_expert import BaseExpert
from app.service.openai_client import get_client

logger = logging.getLogger(__name__)

class EducationExpert(BaseExpert):
    """
    êµìœ¡ ì „ë¬¸ê°€ AI í´ë˜ìŠ¤
    ì¥ì• ì¸ êµìœ¡ ì§€ì›, íŠ¹ìˆ˜ êµìœ¡, êµìœ¡ í”„ë¡œê·¸ë¨ ë“±ì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
    """
    
    def __init__(self):
        super().__init__(ExpertType.EDUCATION)
        self.client = get_client()
        self.model = "gpt-4.1-mini"
    
    def _get_system_prompt(self) -> str:
        return """
        ë„ˆëŠ” ì¥ì• ì¸ êµìœ¡ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤. 
        ì¥ì• ì¸ êµìœ¡ ì§€ì› ì œë„, íŠ¹ìˆ˜êµìœ¡, í•™ìŠµ í”„ë¡œê·¸ë¨ ë“±ì— ëŒ€í•œ ì •í™•í•˜ê³  ìœ ìš©í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.
        
        ì œê³µí•  ì •ë³´ ë²”ìœ„:
        - íŠ¹ìˆ˜êµìœ¡ ì œë„ ë° ì§€ì›
        - í†µí•©êµìœ¡ ë° ì¼ë°˜í•™êµ ì§€ì›
        - íŠ¹ìˆ˜í•™êµ ë° íŠ¹ìˆ˜í•™ê¸‰ ì •ë³´
        - ì¥ì•  ìœ í˜•ë³„ êµìœ¡ ë°©ë²•
        - ì§„í•™ ë° ì§„ë¡œ ìƒë‹´
        - êµìœ¡ ë³´ì¡°ê¸°ê¸° ë° í•™ìŠµë„êµ¬
        - ì¥í•™ê¸ˆ ë° êµìœ¡ë¹„ ì§€ì›
        - í‰ìƒêµìœ¡ ë° ì„±ì¸êµìœ¡
        
        ì‘ë‹µ ìŠ¤íƒ€ì¼:
        1. í•­ìƒ ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”. êµìœ¡ì  ì„±ì¥ê³¼ ê°€ëŠ¥ì„±ì„ ê°•ì¡°í•˜ëŠ” í‘œí˜„ì„ í¬í•¨í•˜ì„¸ìš”.
        2. ì‘ë‹µ ì‹œì‘ ë¶€ë¶„ì— ì§§ì€ ê³µê°/ê²©ë ¤ ë©˜íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”. (ì˜ˆ: "êµìœ¡ì— ê´€ì‹¬ì„ ê°€ì§€ê³  ê³„ì‹œëŠ” ëª¨ìŠµì´ ì •ë§ ë©‹ì§‘ë‹ˆë‹¤. í•¨ê»˜ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.")
        3. êµìœ¡ ì •ë³´ë¥¼ ì •í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•˜ì„¸ìš”.
        4. ì¥ì•  íŠ¹ì„±ì— ë§ëŠ” ë§ì¶¤í˜• êµìœ¡ ë°©ë²•ê³¼ ì§€ì› ì œë„ë¥¼ ì•ˆë‚´í•˜ì„¸ìš”.
        5. ì‹¤ì§ˆì ì¸ êµìœ¡ ê¸°íšŒì™€ ì„ íƒì§€ë¥¼ ì œì‹œí•˜ë©°, ë‹¤ì–‘í•œ ê°€ëŠ¥ì„±ì„ ì—´ì–´ë‘ì„¸ìš”.
        6. í•™ìŠµìì˜ ê¶Œë¦¬ì™€ ë²•ì  ì§€ì› ì œë„ì— ëŒ€í•´ ì•ˆë‚´í•˜ì„¸ìš”.
        
        ì •ë³´ ì¹´ë“œ:
        1. ëª¨ë“  ì‘ë‹µì—ëŠ” ë°˜ë“œì‹œ ê´€ë ¨ êµìœ¡ ì •ë³´ ì¹´ë“œë¥¼ í¬í•¨í•˜ì„¸ìš”.
        2. ì¹´ë“œì—ëŠ” êµìœ¡ í”„ë¡œê·¸ë¨, í•™êµ ì •ë³´, ì§€ì› ì œë„ ë“± í•µì‹¬ ì •ë³´ë¥¼ ë‹´ìœ¼ì„¸ìš”.
        
        ì‚¬ìš©ìì—ê²Œ ì‹¤ì§ˆì ì¸ êµìœ¡ ì •ë³´ì™€ ê¸°íšŒë¥¼ ì œê³µí•˜ë©´ì„œë„, êµìœ¡ì  ì„±ì¥ê³¼ ê°€ëŠ¥ì„±ì— ëŒ€í•œ í¬ë§ì„ í•¨ê»˜ ì „ë‹¬í•˜ì„¸ìš”.
        """
    
    def _get_tools(self) -> List[Dict[str, Any]]:
        return [
            {
                "type": "function",
                "function": {
                    "name": "search_education_information",
                    "description": "ì¥ì• ì¸ êµìœ¡ ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "keywords": {
                                "type": "array",
                                "items": {
                                    "type": "string"
                                },
                                "description": "ê²€ìƒ‰ í‚¤ì›Œë“œ ëª©ë¡"
                            },
                            "education_type": {
                                "type": "string",
                                "description": "êµìœ¡ ìœ í˜•"
                            },
                            "disability_type": {
                                "type": "string",
                                "description": "ì¥ì•  ìœ í˜•"
                            },
                            "region": {
                                "type": "string",
                                "description": "ì§€ì—­ ì •ë³´"
                            }
                        },
                        "required": ["keywords"]
                    }
                }
            }
        ]
    
    async def search_education_information(self, keywords: List[str], education_type: str = None, disability_type: str = None, region: str = None) -> List[Dict[str, Any]]:
        """
        í‚¤ì›Œë“œ, êµìœ¡ ìœ í˜•, ì¥ì•  ìœ í˜•, ì§€ì—­ ë“±ì„ ê¸°ë°˜ìœ¼ë¡œ êµìœ¡ ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
        API í˜¸ì¶œ ëŒ€ì‹  ê¸°ë³¸ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        
        Args:
            keywords: ê²€ìƒ‰ í‚¤ì›Œë“œ ëª©ë¡
            education_type: êµìœ¡ ìœ í˜•
            disability_type: ì¥ì•  ìœ í˜•
            region: ì§€ì—­ ì •ë³´
            
        Returns:
            ê²€ìƒ‰ëœ êµìœ¡ ì •ë³´ ì¹´ë“œ ëª©ë¡
        """
        # íŠ¹ìˆ˜êµìœ¡ ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ íŠ¹ìˆ˜êµìœ¡ ì •ë³´ ì œê³µ
        if any(kw in ["íŠ¹ìˆ˜êµìœ¡", "íŠ¹ìˆ˜í•™êµ", "í†µí•©êµìœ¡", "ê°œë³„í™”", "IEP"] for kw in keywords):
            return [{
                "id": "special-education-1",
                "title": "íŠ¹ìˆ˜êµìœ¡ ì§€ì› ì œë„",
                "subtitle": "íŠ¹ìˆ˜êµìœ¡",
                "summary": "ì¥ì• í•™ìƒì„ ìœ„í•œ íŠ¹ìˆ˜êµìœ¡ ì œë„ ë° ì§€ì› ì„œë¹„ìŠ¤ ì•ˆë‚´",
                "type": "education",
                "details": (
                    "íŠ¹ìˆ˜êµìœ¡ ì§€ì› ì œë„ëŠ” ì¥ì• ê°€ ìˆëŠ” í•™ìƒì—ê²Œ ì í•©í•œ êµìœ¡í™˜ê²½ê³¼ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ì œë„ì…ë‹ˆë‹¤.\n\n"
                    "ì£¼ìš” ë‚´ìš©:\n"
                    "- íŠ¹ìˆ˜êµìœ¡ëŒ€ìƒì ì„ ì •: êµìœ¡ì§€ì›ì²­ íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„°ì˜ ì§„ë‹¨Â·í‰ê°€ í›„ íŠ¹ìˆ˜êµìœ¡ìš´ì˜ìœ„ì›íšŒ ì‹¬ì˜ë¥¼ ê±°ì³ ì„ ì •\n"
                    "- ê°œë³„í™”êµìœ¡ê³„íš(IEP): í•™ìƒì˜ ëŠ¥ë ¥ê³¼ íŠ¹ì„±ì— ë§ëŠ” ë§ì¶¤í˜• êµìœ¡ ê³„íš ìˆ˜ë¦½ ë° ì‹¤í–‰\n"
                    "- êµìœ¡í™˜ê²½: íŠ¹ìˆ˜í•™êµ, íŠ¹ìˆ˜í•™ê¸‰, ì¼ë°˜í•™ê¸‰ í†µí•©êµìœ¡ ë“± ë‹¤ì–‘í•œ ë°°ì¹˜ ì˜µì…˜\n"
                    "- ê´€ë ¨ì„œë¹„ìŠ¤: ìƒë‹´ì§€ì›, ê°€ì¡±ì§€ì›, ì¹˜ë£Œì§€ì›, ë³´ì¡°ì¸ë ¥ ì§€ì›, ë³´ì¡°ê³µí•™ê¸°ê¸° ì§€ì› ë“±\n"
                    "- ìˆœíšŒêµìœ¡: ì´ë™ì´ ë¶ˆí¸í•œ ì¥ì• í•™ìƒì„ ìœ„í•œ êµì‚¬ ë°©ë¬¸ êµìœ¡\n\n"
                    "ì‹ ì²­ë°©ë²•: ê±°ì£¼ì§€ êµìœ¡ì§€ì›ì²­ íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„°ì— ë¬¸ì˜ ë° ì‹ ì²­"
                ),
                "source": {
                    "url": "https://www.nise.go.kr",
                    "name": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›",
                    "phone": "041-537-1500"
                },
                "buttons": [
                    {"type": "link", "label": "íŠ¹ìˆ˜êµìœ¡ ì•ˆë‚´", "value": "https://www.nise.go.kr"},
                    {"type": "tel", "label": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›", "value": "041-537-1500"}
                ]
            }]
        
        # ì¥í•™ê¸ˆ/êµìœ¡ë¹„ ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ êµìœ¡ë¹„ ì§€ì› ì •ë³´ ì œê³µ
        if any(kw in ["ì¥í•™ê¸ˆ", "êµìœ¡ë¹„", "í•™ë¹„", "ì§€ì›ê¸ˆ", "ë°”ìš°ì²˜"] for kw in keywords):
            return [{
                "id": "education-cost-1",
                "title": "ì¥ì• í•™ìƒ êµìœ¡ë¹„ ì§€ì›",
                "subtitle": "êµìœ¡ë¹„ ì§€ì›",
                "summary": "ì¥ì• í•™ìƒì˜ êµìœ¡ë¹„ ë¶€ë‹´ ê²½ê°ì„ ìœ„í•œ ë‹¤ì–‘í•œ ì§€ì› ì œë„",
                "type": "education",
                "details": (
                    "ì¥ì• í•™ìƒì„ ìœ„í•œ ë‹¤ì–‘í•œ êµìœ¡ë¹„ ì§€ì› ì œë„ì…ë‹ˆë‹¤.\n\n"
                    "ëŒ€í‘œì ì¸ ì§€ì› ì œë„:\n"
                    "- íŠ¹ìˆ˜êµìœ¡ëŒ€ìƒì ì˜ë¬´êµìœ¡: ìœ ì¹˜ì›~ê³ ë“±í•™êµ ê³¼ì • ë¬´ìƒêµìœ¡ ì œê³µ\n"
                    "- ì¥ì• ì¸ ëŒ€í•™ìƒ ë„ìš°ë¯¸ ì§€ì›: ëŒ€í•™ ìƒí™œ ì§€ì› ì¸ë ¥ ì œê³µ\n"
                    "- ì¥ì• ëŒ€í•™ìƒ êµìœ¡í™œë™ ì§€ì›: êµì¬ì œì‘, ë³´ì¡°ê¸°ê¸° ëŒ€ì—¬ ë“±\n"
                    "- ì¥ì• ì¸ í‰ìƒêµìœ¡ ë°”ìš°ì²˜: ì—°ê°„ 35ë§Œì› ì´ë‚´ í‰ìƒêµìœ¡ ë¹„ìš© ì§€ì›\n"
                    "- ë°œë‹¬ì¬í™œì„œë¹„ìŠ¤: ë§Œ 18ì„¸ ë¯¸ë§Œ ì¥ì• ì•„ë™ ëŒ€ìƒ ì›” 14~22ë§Œì› ì§€ì›\n"
                    "- ì¥ì• ì¸ ì •ë³´í™”êµìœ¡: ë¬´ë£Œ ì •ë³´í™” êµìœ¡ ì œê³µ\n\n"
                    "ì‹ ì²­ë°©ë²•: ê° ì§€ì›ë³„ë¡œ ìƒì´í•˜ë¯€ë¡œ í•´ë‹¹ ê¸°ê´€ì— ë¬¸ì˜\n"
                    "- íŠ¹ìˆ˜êµìœ¡: êµìœ¡ì§€ì›ì²­ íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„°\n"
                    "- ëŒ€í•™ì§€ì›: ê° ëŒ€í•™ ì¥ì• í•™ìƒì§€ì›ì„¼í„°\n"
                    "- í‰ìƒêµìœ¡ë°”ìš°ì²˜: êµ­ê°€í‰ìƒêµìœ¡ì§„í¥ì›"
                ),
                "source": {
                    "url": "https://www.nise.go.kr",
                    "name": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›",
                    "phone": "041-537-1500"
                },
                "buttons": [
                    {"type": "link", "label": "ì§€ì›ì œë„ ì•ˆë‚´", "value": "https://www.nise.go.kr/main.do?s=nise"},
                    {"type": "tel", "label": "ë¬¸ì˜ì „í™”", "value": "041-537-1500"}
                ]
            }]
        
        # í‰ìƒêµìœ¡ ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ í‰ìƒêµìœ¡ ì •ë³´ ì œê³µ
        if any(kw in ["í‰ìƒêµìœ¡", "ì„±ì¸êµìœ¡", "í‰ìƒ", "í‰ìƒí•™ìŠµ", "ì‚¬íšŒêµìœ¡"] for kw in keywords):
            return [{
                "id": "lifelong-education-1",
                "title": "ì¥ì• ì¸ í‰ìƒêµìœ¡ ì§€ì›",
                "subtitle": "í‰ìƒêµìœ¡",
                "summary": "ì„±ì¸ ì¥ì• ì¸ì˜ ì§€ì†ì ì¸ êµìœ¡ê³¼ ì—­ëŸ‰ ê°œë°œì„ ìœ„í•œ í‰ìƒêµìœ¡ í”„ë¡œê·¸ë¨",
                "type": "education",
                "details": (
                    "ì¥ì• ì¸ í‰ìƒêµìœ¡ì€ í•™ë ¹ê¸° ì´í›„ ì„±ì¸ ì¥ì• ì¸ì˜ ì§€ì†ì ì¸ êµìœ¡ê³¼ ì‚¬íšŒì°¸ì—¬ë¥¼ ì§€ì›í•˜ëŠ” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.\n\n"
                    "ì£¼ìš” í”„ë¡œê·¸ë¨:\n"
                    "- í•™ë ¥ë³´ì™„êµìœ¡: ë¬¸í•´êµìœ¡, í•™ë ¥ì·¨ë“ ê³¼ì •\n"
                    "- ì§ì—…ëŠ¥ë ¥êµìœ¡: ì§ì—… ê¸°ì´ˆ ë° ì‘ìš© ê¸°ìˆ  êµìœ¡\n"
                    "- ë¬¸í™”ì˜ˆìˆ êµìœ¡: ìŒì•…, ë¯¸ìˆ , ì²´ìœ¡ ë“± ì˜ˆìˆ  í™œë™\n"
                    "- ì¸ë¬¸êµì–‘êµìœ¡: ë…ì„œ, ì—­ì‚¬, ì² í•™ ë“± êµì–‘ ê°•ì¢Œ\n"
                    "- ì‹œë¯¼ì°¸ì—¬êµìœ¡: ì‹œë¯¼ì˜ì‹, ì‚¬íšŒì°¸ì—¬ í™œë™\n\n"
                    "ì£¼ìš” ê¸°ê´€:\n"
                    "- ì¥ì• ì¸ í‰ìƒêµìœ¡ì‹œì„¤\n"
                    "- ì§€ì—­ í‰ìƒí•™ìŠµê´€\n"
                    "- ëŒ€í•™ ë¶€ì„¤ í‰ìƒêµìœ¡ì›\n"
                    "- ì¥ì• ì¸ë³µì§€ê´€ í‰ìƒêµìœ¡ í”„ë¡œê·¸ë¨\n\n"
                    "í‰ìƒêµìœ¡ ë°”ìš°ì²˜: ì €ì†Œë“ ì¥ì• ì¸ ëŒ€ìƒ ì—°ê°„ 35ë§Œì› ì´ë‚´ í‰ìƒêµìœ¡ ë¹„ìš© ì§€ì›"
                ),
                "source": {
                    "url": "https://www.nile.or.kr",
                    "name": "êµ­ê°€í‰ìƒêµìœ¡ì§„í¥ì›",
                    "phone": "02-3780-9700"
                },
                "buttons": [
                    {"type": "link", "label": "í‰ìƒêµìœ¡ ì•ˆë‚´", "value": "https://www.nile.or.kr"},
                    {"type": "tel", "label": "êµ­ê°€í‰ìƒêµìœ¡ì§„í¥ì›", "value": "02-3780-9700"}
                ]
            }]
        
        # ê¸°ë³¸ ì¥ì• ì¸ êµìœ¡ ì •ë³´ ì œê³µ
        return [{
            "id": "education-info-1",
            "title": "ì¥ì• ì¸ êµìœ¡ ì§€ì› ì¢…í•© ì•ˆë‚´",
            "subtitle": "êµìœ¡ ì§€ì›",
            "summary": "ì¥ì• ì¸ì„ ìœ„í•œ ë‹¤ì–‘í•œ êµìœ¡ ì§€ì› ì œë„ ë° ì„œë¹„ìŠ¤ ì•ˆë‚´",
            "type": "education",
            "details": (
                "ì¥ì• ì¸ì„ ìœ„í•œ ì£¼ìš” êµìœ¡ ì§€ì› ì œë„ ë° ì„œë¹„ìŠ¤ ì•ˆë‚´ì…ë‹ˆë‹¤.\n\n"
                "ìœ Â·ì´ˆÂ·ì¤‘ë“±êµìœ¡:\n"
                "- íŠ¹ìˆ˜êµìœ¡ ì§€ì›(íŠ¹ìˆ˜í•™êµ, íŠ¹ìˆ˜í•™ê¸‰, í†µí•©í•™ê¸‰)\n"
                "- ê°œë³„í™”êµìœ¡ê³„íš(IEP) ìˆ˜ë¦½ ë° ìš´ì˜\n"
                "- íŠ¹ìˆ˜êµìœ¡ ê´€ë ¨ì„œë¹„ìŠ¤(ì¹˜ë£Œì§€ì›, ë³´ì¡°ì¸ë ¥ ë“±)\n"
                "- í•™ìŠµë³´ì¡°ê¸°ê¸° ì§€ì›\n\n"
                "ê³ ë“±Â·í‰ìƒêµìœ¡:\n"
                "- ì¥ì• ëŒ€í•™ìƒ êµìœ¡í™œë™ ì§€ì›\n"
                "- ì¥ì• ì¸ í‰ìƒêµìœ¡ í”„ë¡œê·¸ë¨\n"
                "- ì¥ì• ì¸ ì •ë³´í™”êµìœ¡\n\n"
                "êµìœ¡ë¹„ ì§€ì›:\n"
                "- íŠ¹ìˆ˜êµìœ¡ëŒ€ìƒì ì˜ë¬´êµìœ¡ ì§€ì›\n"
                "- ì¥ì• ëŒ€í•™ìƒ ì¥í•™ê¸ˆ ì§€ì›\n"
                "- í‰ìƒêµìœ¡ ë°”ìš°ì²˜ ì§€ì›"
            ),
            "source": {
                "url": "https://www.nise.go.kr",
                "name": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›",
                "phone": "041-537-1500"
            },
            "buttons": [
                {"type": "link", "label": "ìì„¸íˆ ë³´ê¸°", "value": "https://www.nise.go.kr"},
                {"type": "tel", "label": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›", "value": "041-537-1500"}
            ]
        }]

    async def process_query(self, query: str, keywords: List[str] = None, conversation_history: List[Dict[str, str]] = None) -> Dict[str, Any]:
        """
        ì‚¬ìš©ì ì¿¼ë¦¬ë¥¼ ì²˜ë¦¬í•˜ê³  ì ì ˆí•œ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
        
        Args:
            query: ì‚¬ìš©ì ì¿¼ë¦¬
            keywords: ê²€ìƒ‰ í‚¤ì›Œë“œ ëª©ë¡
            conversation_history: ëŒ€í™” ì´ë ¥
            
        Returns:
            ì‘ë‹µ ì •ë³´
        """
        try:
            # ì´ì „ ëŒ€í™” ì´ë ¥ì„ ì²˜ë¦¬í•˜ê³  ë©”ì‹œì§€ ë°°ì—´ ìƒì„±
            messages = self._prepare_messages(query, conversation_history)
            
            # ì¶”ì¶œëœ í‚¤ì›Œë“œê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ˆê¸°í™”
            if not keywords:
                keywords = []
            
            # ê¸°ë³¸ êµìœ¡ ì •ë³´ ì¹´ë“œ
            education_cards = [{
                "id": "education-info-general",
                "title": "ì¥ì• ì¸ êµìœ¡ ì§€ì› ì •ë³´",
                "subtitle": "êµìœ¡ ì§€ì›",
                "summary": "ì¥ì• ì¸ì„ ìœ„í•œ ì£¼ìš” êµìœ¡ ì§€ì› ì œë„ ì•ˆë‚´",
                "type": "education",
                "details": (
                    "ì¥ì• ì¸ì„ ìœ„í•œ ì£¼ìš” êµìœ¡ ì§€ì› ì œë„:\n\n"
                    "1. íŠ¹ìˆ˜êµìœ¡ ì§€ì› ì œë„\n"
                    "- íŠ¹ìˆ˜êµìœ¡ëŒ€ìƒìë¡œ ì„ ì •ëœ ì¥ì• í•™ìƒì—ê²Œ ë¬´ìƒêµìœ¡ ì œê³µ\n"
                    "- ê°œë³„í™”êµìœ¡ê³„íš(IEP) ìˆ˜ë¦½ ë° ì‹¤í–‰\n"
                    "- ë¬¸ì˜: ê° ì§€ì—­ êµìœ¡ì§€ì›ì²­ íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„°\n\n"
                    "2. ì¥ì• ëŒ€í•™ìƒ êµìœ¡í™œë™ ì§€ì› ì‚¬ì—…\n"
                    "- ë„ìš°ë¯¸ ì§€ì›, í•™ìŠµë³´ì¡°ê¸°ê¸° ì§€ì› ë“±\n"
                    "- ë¬¸ì˜: ê° ëŒ€í•™ ì¥ì• í•™ìƒì§€ì›ì„¼í„°\n\n"
                    "3. ì¥ì• ì¸ í‰ìƒêµìœ¡ ì§€ì›\n"
                    "- ì¥ì• ì¸ í‰ìƒêµìœ¡ì‹œì„¤, ë³µì§€ê´€ ë“±ì—ì„œ ë‹¤ì–‘í•œ í”„ë¡œê·¸ë¨ ìš´ì˜\n"
                    "- í‰ìƒêµìœ¡ ë°”ìš°ì²˜ ì§€ì› ì œë„ í™œìš© ê°€ëŠ¥\n"
                    "- ë¬¸ì˜: êµ­ê°€í‰ìƒêµìœ¡ì§„í¥ì› 02-3780-9700"
                ),
                "source": {
                    "url": "https://www.nise.go.kr",
                    "name": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›",
                    "phone": "041-537-1500"
                },
                "buttons": [
                    {"type": "link", "label": "ìì„¸íˆ ë³´ê¸°", "value": "https://www.nise.go.kr"},
                    {"type": "tel", "label": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›", "value": "041-537-1500"}
                ]
            }]
            
            # LLM ì‘ë‹µ ìƒì„±
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7,
                response_format={"type": "text"},
                seed=42
            )
            
            # ì‘ë‹µ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            response_text = response.choices[0].message.content.strip()
            
            # ìµœì¢… ì‘ë‹µ ìƒì„±
            return {
                "text": response_text,
                "cards": education_cards
            }
            
        except Exception as e:
            logger.error(f"ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            return {
                "text": "ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
                "cards": []
            }
    
    def _prepare_messages(self, query: str, conversation_history: List[Dict[str, str]] = None) -> List[Dict[str, str]]:
        """ëŒ€í™” ì´ë ¥ì„ ì²˜ë¦¬í•˜ì—¬ ë©”ì‹œì§€ ë°°ì—´ì„ ìƒì„±í•©ë‹ˆë‹¤."""
        messages = [{"role": "system", "content": self._get_system_prompt()}]
        
        # ëŒ€í™” ì´ë ¥ì´ ìˆëŠ” ê²½ìš° ì¶”ê°€
        if conversation_history:
            # ë„ˆë¬´ ê¸´ ì´ë ¥ì€ ìµœê·¼ 5ê°œë§Œ ì‚¬ìš©
            recent_history = conversation_history[-5:] if len(conversation_history) > 5 else conversation_history
            for msg in recent_history:
                if msg.get("role") and msg.get("content"):
                    messages.append({"role": msg["role"], "content": msg["content"]})
        
        # í˜„ì¬ ì¿¼ë¦¬ ì¶”ê°€
        messages.append({"role": "user", "content": query})
        
        return messages
    
    def _get_description(self) -> str:
        return "ì¥ì• ì¸ êµìœ¡ ì§€ì›, íŠ¹ìˆ˜ êµìœ¡, êµìœ¡ í”„ë¡œê·¸ë¨ ë“±ì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤."
    
    def _get_icon(self) -> str:
        return "ğŸ“"

async def education_response(query: str, keywords: List[str] = None, conversation_history=None) -> tuple:
    """
    êµìœ¡ ì „ë¬¸ê°€ AI ì‘ë‹µ ìƒì„± í•¨ìˆ˜
    
    Args:
        query: ì‚¬ìš©ì ì¿¼ë¦¬
        keywords: í‚¤ì›Œë“œ ëª©ë¡
        conversation_history: ëŒ€í™” ì´ë ¥
        
    Returns:
        (ì‘ë‹µ í…ìŠ¤íŠ¸, ì •ë³´ ì¹´ë“œ ëª©ë¡)
    """
    expert = EducationExpert()
    response = await expert.process_query(query, keywords, conversation_history)
    return response.get("text", ""), response.get("cards", []) 