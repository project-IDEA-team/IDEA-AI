from typing import Dict, List, Any
import logging
from app.models.expert_type import ExpertType
from app.service.experts.base_expert import BaseExpert
from app.service.openai_client import get_client
from app.service.public_api.api_manager import ApiManager

logger = logging.getLogger(__name__)

class EducationExpert(BaseExpert):
    """
    êµìœ¡ ì „ë¬¸ê°€ AI í´ë˜ìŠ¤
    ì¥ì• ì¸ êµìœ¡ ì§€ì›, íŠ¹ìˆ˜ êµìœ¡, êµìœ¡ í”„ë¡œê·¸ë¨ ë“±ì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
    """
    
    def __init__(self):
        super().__init__(ExpertType.EDUCATION)
        self.client = get_client()
        self.api_manager = ApiManager()
    
    def _get_system_prompt(self) -> str:
        return """
        ë„ˆëŠ” ì¥ì• ì¸ êµìœ¡ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤. 
        ì¥ì• ì¸ êµìœ¡ ì§€ì› ì œë„, íŠ¹ìˆ˜êµìœ¡, í•™ìŠµ í”„ë¡œê·¸ë¨ ë“±ì— ëŒ€í•œ ì •í™•í•˜ê³  ìœ ìš©í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.
        
        ì œê³µí•  ì •ë³´ ë²”ìœ„:
        - íŠ¹ìˆ˜êµìœ¡ ì œë„ ë° ì§€ì›
        - í†µí•©êµìœ¡ ë° ì¼ë°˜í•™êµ ì§€ì›
        - íŠ¹ìˆ˜í•™êµ ë° íŠ¹ìˆ˜í•™ê¸‰ ì •ë³´
        - ì¥ì•  ìœ í˜•ë³„ êµìœ¡ ë°©ë²•
        - ì§„í•™ ë° ì§„ë¡œ ìƒë‹´
        - êµìœ¡ ë³´ì¡°ê¸°ê¸° ë° í•™ìŠµë„êµ¬
        - ì¥í•™ê¸ˆ ë° êµìœ¡ë¹„ ì§€ì›
        - í‰ìƒêµìœ¡ ë° ì„±ì¸êµìœ¡
        
        ì‘ë‹µ ìŠ¤íƒ€ì¼:
        1. í•­ìƒ ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”. êµìœ¡ì  ì„±ì¥ê³¼ ê°€ëŠ¥ì„±ì„ ê°•ì¡°í•˜ëŠ” í‘œí˜„ì„ í¬í•¨í•˜ì„¸ìš”.
        2. ì‘ë‹µ ì‹œì‘ ë¶€ë¶„ì— ì§§ì€ ê³µê°/ê²©ë ¤ ë©˜íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”. (ì˜ˆ: "êµìœ¡ì— ê´€ì‹¬ì„ ê°€ì§€ê³  ê³„ì‹œëŠ” ëª¨ìŠµì´ ì •ë§ ë©‹ì§‘ë‹ˆë‹¤. í•¨ê»˜ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.")
        3. êµìœ¡ ì •ë³´ë¥¼ ì •í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•˜ì„¸ìš”.
        4. ì¥ì•  íŠ¹ì„±ì— ë§ëŠ” ë§ì¶¤í˜• êµìœ¡ ë°©ë²•ê³¼ ì§€ì› ì œë„ë¥¼ ì•ˆë‚´í•˜ì„¸ìš”.
        5. ì‹¤ì§ˆì ì¸ êµìœ¡ ê¸°íšŒì™€ ì„ íƒì§€ë¥¼ ì œì‹œí•˜ë©°, ë‹¤ì–‘í•œ ê°€ëŠ¥ì„±ì„ ì—´ì–´ë‘ì„¸ìš”.
        6. í•™ìŠµìì˜ ê¶Œë¦¬ì™€ ë²•ì  ì§€ì› ì œë„ì— ëŒ€í•´ ì•ˆë‚´í•˜ì„¸ìš”.
        
        ì •ë³´ ì¹´ë“œ:
        1. ëª¨ë“  ì‘ë‹µì—ëŠ” ë°˜ë“œì‹œ ê´€ë ¨ êµìœ¡ ì •ë³´ ì¹´ë“œë¥¼ í¬í•¨í•˜ì„¸ìš”.
        2. ì¹´ë“œì—ëŠ” êµìœ¡ í”„ë¡œê·¸ë¨, í•™êµ ì •ë³´, ì§€ì› ì œë„ ë“± í•µì‹¬ ì •ë³´ë¥¼ ë‹´ìœ¼ì„¸ìš”.
        
        ì‚¬ìš©ìì—ê²Œ ì‹¤ì§ˆì ì¸ êµìœ¡ ì •ë³´ì™€ ê¸°íšŒë¥¼ ì œê³µí•˜ë©´ì„œë„, êµìœ¡ì  ì„±ì¥ê³¼ ê°€ëŠ¥ì„±ì— ëŒ€í•œ í¬ë§ì„ í•¨ê»˜ ì „ë‹¬í•˜ì„¸ìš”.
        """
    
    def _get_tools(self) -> List[Dict[str, Any]]:
        return [
            {
                "type": "function",
                "function": {
                    "name": "search_education_information",
                    "description": "ì¥ì• ì¸ êµìœ¡ ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "keywords": {
                                "type": "array",
                                "items": {
                                    "type": "string"
                                },
                                "description": "ê²€ìƒ‰ í‚¤ì›Œë“œ ëª©ë¡"
                            },
                            "education_type": {
                                "type": "string",
                                "description": "êµìœ¡ ìœ í˜•"
                            },
                            "disability_type": {
                                "type": "string",
                                "description": "ì¥ì•  ìœ í˜•"
                            },
                            "region": {
                                "type": "string",
                                "description": "ì§€ì—­ ì •ë³´"
                            }
                        },
                        "required": ["keywords"]
                    }
                }
            }
        ]
    
    async def search_education_information(self, keywords: List[str], education_type: str = None, disability_type: str = None, region: str = None) -> List[Dict[str, Any]]:
        """
        í‚¤ì›Œë“œ, êµìœ¡ ìœ í˜•, ì¥ì•  ìœ í˜•, ì§€ì—­ ë“±ì„ ê¸°ë°˜ìœ¼ë¡œ êµìœ¡ ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
        
        Args:
            keywords: ê²€ìƒ‰ í‚¤ì›Œë“œ ëª©ë¡
            education_type: êµìœ¡ ìœ í˜•
            disability_type: ì¥ì•  ìœ í˜•
            region: ì§€ì—­ ì •ë³´
            
        Returns:
            ê²€ìƒ‰ëœ êµìœ¡ ì •ë³´ ì¹´ë“œ ëª©ë¡
        """
        try:
            # ApiManagerë¥¼ í†µí•´ ê³µê³µë°ì´í„° APIì—ì„œ êµìœ¡ ì •ë³´ ê²€ìƒ‰
            education_cards = await self.api_manager.search_by_keywords(keywords, "êµìœ¡")
            
            # ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë°˜í™˜
            if education_cards:
                return education_cards
                
            # ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš° ë°±ì—… ë°ì´í„° í™œìš©
            # 2ì°¨ ì‹œë„: íŠ¹ìˆ˜êµìœ¡ ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ íŠ¹ìˆ˜êµìœ¡ ì •ë³´ ì œê³µ
            if any(kw in ["íŠ¹ìˆ˜êµìœ¡", "íŠ¹ìˆ˜í•™êµ", "í†µí•©êµìœ¡", "ê°œë³„í™”", "IEP"] for kw in keywords):
                return [{
                    "id": "special-education-1",
                    "title": "íŠ¹ìˆ˜êµìœ¡ ì§€ì› ì œë„",
                    "subtitle": "íŠ¹ìˆ˜êµìœ¡",
                    "summary": "ì¥ì• í•™ìƒì„ ìœ„í•œ íŠ¹ìˆ˜êµìœ¡ ì œë„ ë° ì§€ì› ì„œë¹„ìŠ¤ ì•ˆë‚´",
                    "type": "education",
                    "details": (
                        "íŠ¹ìˆ˜êµìœ¡ ì§€ì› ì œë„ëŠ” ì¥ì• ê°€ ìˆëŠ” í•™ìƒì—ê²Œ ì í•©í•œ êµìœ¡í™˜ê²½ê³¼ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ì œë„ì…ë‹ˆë‹¤.\n\n"
                        "ì£¼ìš” ë‚´ìš©:\n"
                        "- íŠ¹ìˆ˜êµìœ¡ëŒ€ìƒì ì„ ì •: êµìœ¡ì§€ì›ì²­ íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„°ì˜ ì§„ë‹¨Â·í‰ê°€ í›„ íŠ¹ìˆ˜êµìœ¡ìš´ì˜ìœ„ì›íšŒ ì‹¬ì˜ë¥¼ ê±°ì³ ì„ ì •\n"
                        "- ê°œë³„í™”êµìœ¡ê³„íš(IEP): í•™ìƒì˜ ëŠ¥ë ¥ê³¼ íŠ¹ì„±ì— ë§ëŠ” ë§ì¶¤í˜• êµìœ¡ ê³„íš ìˆ˜ë¦½ ë° ì‹¤í–‰\n"
                        "- êµìœ¡í™˜ê²½: íŠ¹ìˆ˜í•™êµ, íŠ¹ìˆ˜í•™ê¸‰, ì¼ë°˜í•™ê¸‰ í†µí•©êµìœ¡ ë“± ë‹¤ì–‘í•œ ë°°ì¹˜ ì˜µì…˜\n"
                        "- ê´€ë ¨ì„œë¹„ìŠ¤: ìƒë‹´ì§€ì›, ê°€ì¡±ì§€ì›, ì¹˜ë£Œì§€ì›, ë³´ì¡°ì¸ë ¥ ì§€ì›, ë³´ì¡°ê³µí•™ê¸°ê¸° ì§€ì› ë“±\n"
                        "- ìˆœíšŒêµìœ¡: ì´ë™ì´ ë¶ˆí¸í•œ ì¥ì• í•™ìƒì„ ìœ„í•œ êµì‚¬ ë°©ë¬¸ êµìœ¡\n\n"
                        "ì‹ ì²­ë°©ë²•: ê±°ì£¼ì§€ êµìœ¡ì§€ì›ì²­ íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„°ì— ë¬¸ì˜ ë° ì‹ ì²­"
                    ),
                    "source": {
                        "url": "https://www.nise.go.kr",
                        "name": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›",
                        "phone": "041-537-1500"
                    },
                    "buttons": [
                        {"type": "link", "label": "íŠ¹ìˆ˜êµìœ¡ ì•ˆë‚´", "value": "https://www.nise.go.kr"},
                        {"type": "tel", "label": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›", "value": "041-537-1500"}
                    ]
                }]
            
            # 3ì°¨ ì‹œë„: ì¥í•™ê¸ˆ/êµìœ¡ë¹„ ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ êµìœ¡ë¹„ ì§€ì› ì •ë³´ ì œê³µ
            if any(kw in ["ì¥í•™ê¸ˆ", "êµìœ¡ë¹„", "í•™ë¹„", "ì§€ì›ê¸ˆ", "ë°”ìš°ì²˜"] for kw in keywords):
                return [{
                    "id": "education-cost-1",
                    "title": "ì¥ì• í•™ìƒ êµìœ¡ë¹„ ì§€ì›",
                    "subtitle": "êµìœ¡ë¹„ ì§€ì›",
                    "summary": "ì¥ì• í•™ìƒì˜ êµìœ¡ë¹„ ë¶€ë‹´ ê²½ê°ì„ ìœ„í•œ ë‹¤ì–‘í•œ ì§€ì› ì œë„",
                    "type": "education",
                    "details": (
                        "ì¥ì• í•™ìƒì„ ìœ„í•œ ë‹¤ì–‘í•œ êµìœ¡ë¹„ ì§€ì› ì œë„ì…ë‹ˆë‹¤.\n\n"
                        "ëŒ€í‘œì ì¸ ì§€ì› ì œë„:\n"
                        "- íŠ¹ìˆ˜êµìœ¡ëŒ€ìƒì ì˜ë¬´êµìœ¡: ìœ ì¹˜ì›~ê³ ë“±í•™êµ ê³¼ì • ë¬´ìƒêµìœ¡ ì œê³µ\n"
                        "- ì¥ì• ì¸ ëŒ€í•™ìƒ ë„ìš°ë¯¸ ì§€ì›: ëŒ€í•™ ìƒí™œ ì§€ì› ì¸ë ¥ ì œê³µ\n"
                        "- ì¥ì• ëŒ€í•™ìƒ êµìœ¡í™œë™ ì§€ì›: êµì¬ì œì‘, ë³´ì¡°ê¸°ê¸° ëŒ€ì—¬ ë“±\n"
                        "- ì¥ì• ì¸ í‰ìƒêµìœ¡ ë°”ìš°ì²˜: ì—°ê°„ 35ë§Œì› ì´ë‚´ í‰ìƒêµìœ¡ ë¹„ìš© ì§€ì›\n"
                        "- ë°œë‹¬ì¬í™œì„œë¹„ìŠ¤: ë§Œ 18ì„¸ ë¯¸ë§Œ ì¥ì• ì•„ë™ ëŒ€ìƒ ì›” 14~22ë§Œì› ì§€ì›\n"
                        "- ì¥ì• ì¸ ì •ë³´í™”êµìœ¡: ë¬´ë£Œ ì •ë³´í™” êµìœ¡ ì œê³µ\n\n"
                        "ì‹ ì²­ë°©ë²•: ê° ì§€ì›ë³„ë¡œ ìƒì´í•˜ë¯€ë¡œ í•´ë‹¹ ê¸°ê´€ì— ë¬¸ì˜\n"
                        "- íŠ¹ìˆ˜êµìœ¡: êµìœ¡ì§€ì›ì²­ íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„°\n"
                        "- ëŒ€í•™ì§€ì›: ê° ëŒ€í•™ ì¥ì• í•™ìƒì§€ì›ì„¼í„°\n"
                        "- í‰ìƒêµìœ¡ë°”ìš°ì²˜: êµ­ê°€í‰ìƒêµìœ¡ì§„í¥ì›"
                    ),
                    "source": {
                        "url": "https://www.nise.go.kr",
                        "name": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›",
                        "phone": "041-537-1500"
                    },
                    "buttons": [
                        {"type": "link", "label": "ì§€ì›ì œë„ ì•ˆë‚´", "value": "https://www.nise.go.kr/main.do?s=nise"},
                        {"type": "tel", "label": "ë¬¸ì˜ì „í™”", "value": "041-537-1500"}
                    ]
                }]
            
            # í‰ìƒêµìœ¡ ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ í‰ìƒêµìœ¡ ì •ë³´ ì œê³µ
            if any(kw in ["í‰ìƒêµìœ¡", "ì„±ì¸êµìœ¡", "í‰ìƒ", "í‰ìƒí•™ìŠµ", "ì‚¬íšŒêµìœ¡"] for kw in keywords):
                return [{
                    "id": "lifelong-education-1",
                    "title": "ì¥ì• ì¸ í‰ìƒêµìœ¡ ì§€ì›",
                    "subtitle": "í‰ìƒêµìœ¡",
                    "summary": "ì„±ì¸ ì¥ì• ì¸ì˜ ì§€ì†ì ì¸ êµìœ¡ê³¼ ì—­ëŸ‰ ê°œë°œì„ ìœ„í•œ í‰ìƒêµìœ¡ í”„ë¡œê·¸ë¨",
                    "type": "education",
                    "details": (
                        "ì¥ì• ì¸ í‰ìƒêµìœ¡ì€ í•™ë ¹ê¸° ì´í›„ ì„±ì¸ ì¥ì• ì¸ì˜ ì§€ì†ì ì¸ êµìœ¡ê³¼ ì‚¬íšŒì°¸ì—¬ë¥¼ ì§€ì›í•˜ëŠ” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.\n\n"
                        "ì£¼ìš” í”„ë¡œê·¸ë¨:\n"
                        "- í•™ë ¥ë³´ì™„êµìœ¡: ë¬¸í•´êµìœ¡, í•™ë ¥ì·¨ë“ ê³¼ì •\n"
                        "- ì§ì—…ëŠ¥ë ¥êµìœ¡: ì§ì—… ê¸°ì´ˆ ë° ì‘ìš© ê¸°ìˆ  êµìœ¡\n"
                        "- ë¬¸í™”ì˜ˆìˆ êµìœ¡: ìŒì•…, ë¯¸ìˆ , ì²´ìœ¡ ë“± ì˜ˆìˆ  í™œë™\n"
                        "- ì¸ë¬¸êµì–‘êµìœ¡: ë…ì„œ, ì—­ì‚¬, ì² í•™ ë“± êµì–‘ ê°•ì¢Œ\n"
                        "- ì‹œë¯¼ì°¸ì—¬êµìœ¡: ì‹œë¯¼ì˜ì‹, ì‚¬íšŒì°¸ì—¬ í™œë™\n\n"
                        "ì£¼ìš” ê¸°ê´€:\n"
                        "- ì¥ì• ì¸ í‰ìƒêµìœ¡ì‹œì„¤\n"
                        "- ì§€ì—­ í‰ìƒí•™ìŠµê´€\n"
                        "- ëŒ€í•™ ë¶€ì„¤ í‰ìƒêµìœ¡ì›\n"
                        "- ì¥ì• ì¸ë³µì§€ê´€ í‰ìƒêµìœ¡ í”„ë¡œê·¸ë¨\n\n"
                        "í‰ìƒêµìœ¡ ë°”ìš°ì²˜: ì €ì†Œë“ ì¥ì• ì¸ ëŒ€ìƒ ì—°ê°„ 35ë§Œì› ì´ë‚´ í‰ìƒêµìœ¡ ë¹„ìš© ì§€ì›"
                    ),
                    "source": {
                        "url": "https://www.nile.or.kr",
                        "name": "êµ­ê°€í‰ìƒêµìœ¡ì§„í¥ì›",
                        "phone": "02-3780-9700"
                    },
                    "buttons": [
                        {"type": "link", "label": "í‰ìƒêµìœ¡ ì•ˆë‚´", "value": "https://www.nile.or.kr"},
                        {"type": "tel", "label": "êµ­ê°€í‰ìƒêµìœ¡ì§„í¥ì›", "value": "02-3780-9700"}
                    ]
                }]
            
            # ìµœí›„ ë°©ì•ˆ: ê¸°ë³¸ ì¥ì• ì¸ êµìœ¡ ì •ë³´ ì œê³µ
            return [{
                "id": "education-info-1",
                "title": "ì¥ì• ì¸ êµìœ¡ ì§€ì› ì¢…í•© ì•ˆë‚´",
                "subtitle": "êµìœ¡ ì§€ì›",
                "summary": "ì¥ì• ì¸ì„ ìœ„í•œ ë‹¤ì–‘í•œ êµìœ¡ ì§€ì› ì œë„ ë° ì„œë¹„ìŠ¤ ì•ˆë‚´",
                "type": "education",
                "details": (
                    "ì¥ì• ì¸ì„ ìœ„í•œ ì£¼ìš” êµìœ¡ ì§€ì› ì œë„ ë° ì„œë¹„ìŠ¤ ì•ˆë‚´ì…ë‹ˆë‹¤.\n\n"
                    "ìœ Â·ì´ˆÂ·ì¤‘ë“±êµìœ¡:\n"
                    "- íŠ¹ìˆ˜êµìœ¡ ì§€ì›(íŠ¹ìˆ˜í•™êµ, íŠ¹ìˆ˜í•™ê¸‰, í†µí•©í•™ê¸‰)\n"
                    "- ê°œë³„í™”êµìœ¡ê³„íš(IEP) ìˆ˜ë¦½ ë° ìš´ì˜\n"
                    "- íŠ¹ìˆ˜êµìœ¡ ê´€ë ¨ì„œë¹„ìŠ¤(ì¹˜ë£Œì§€ì›, ë³´ì¡°ì¸ë ¥ ë“±)\n"
                    "- í•™ìŠµë³´ì¡°ê¸°ê¸° ì§€ì›\n\n"
                    "ê³ ë“±Â·í‰ìƒêµìœ¡:\n"
                    "- ì¥ì• ëŒ€í•™ìƒ êµìœ¡í™œë™ ì§€ì›\n"
                    "- ì¥ì• ì¸ í‰ìƒêµìœ¡ í”„ë¡œê·¸ë¨\n"
                    "- ì¥ì• ì¸ ì •ë³´í™”êµìœ¡\n\n"
                    "êµìœ¡ë¹„ ì§€ì›:\n"
                    "- íŠ¹ìˆ˜êµìœ¡ëŒ€ìƒì ì˜ë¬´êµìœ¡ ì§€ì›\n"
                    "- ì¥ì• ëŒ€í•™ìƒ ì¥í•™ê¸ˆ ì§€ì›\n"
                    "- í‰ìƒêµìœ¡ ë°”ìš°ì²˜ ì§€ì›"
                ),
                "source": {
                    "url": "https://www.nise.go.kr",
                    "name": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›",
                    "phone": "041-537-1500"
                },
                "buttons": [
                    {"type": "link", "label": "ìì„¸íˆ ë³´ê¸°", "value": "https://www.nise.go.kr"},
                    {"type": "tel", "label": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›", "value": "041-537-1500"}
                ]
            }]
            
        except Exception as e:
            logger.error(f"êµìœ¡ ì •ë³´ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            # ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë°ì´í„° ë°˜í™˜
            return [{
                "id": "education-error",
                "title": "ì¥ì• ì¸ êµìœ¡ ì •ë³´ ì•ˆë‚´",
                "subtitle": "êµìœ¡ ì •ë³´",
                "summary": "ì¥ì• ì¸ì„ ìœ„í•œ ì£¼ìš” êµìœ¡ ì§€ì› ì œë„ ì•ˆë‚´",
                "type": "education",
                "details": (
                    "ì¥ì• ì¸ì„ ìœ„í•œ ë‹¤ì–‘í•œ êµìœ¡ ì§€ì› ì œë„ê°€ ìˆìŠµë‹ˆë‹¤:\n"
                    "- íŠ¹ìˆ˜êµìœ¡ ì§€ì› ì œë„\n"
                    "- í†µí•©êµìœ¡ ì§€ì›\n"
                    "- ê°œë³„í™”êµìœ¡ê³„íš(IEP)\n"
                    "- êµìœ¡ë¹„ ì§€ì› í”„ë¡œê·¸ë¨\n"
                    "- í‰ìƒêµìœ¡ ì§€ì›\n\n"
                    "ìì„¸í•œ ë‚´ìš©ì€ êµìœ¡ì§€ì›ì²­ íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„°ë‚˜ êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›ì— ë¬¸ì˜í•˜ì„¸ìš”."
                ),
                "source": {
                    "url": "https://www.nise.go.kr",
                    "name": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›",
                    "phone": "041-537-1500"
                },
                "buttons": [
                    {"type": "link", "label": "êµìœ¡ì§€ì› ì•ˆë‚´", "value": "https://www.nise.go.kr"},
                    {"type": "tel", "label": "êµ­ë¦½íŠ¹ìˆ˜êµìœ¡ì›", "value": "041-537-1500"}
                ]
            }]
    
    async def process_query(self, query: str, keywords: List[str] = None, conversation_history: List[Dict[str, str]] = None) -> Dict[str, Any]:
        """
        ì‚¬ìš©ì ì¿¼ë¦¬ë¥¼ ì²˜ë¦¬í•˜ê³  ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        
        Args:
            query: ì‚¬ìš©ì ì¿¼ë¦¬
            keywords: ìŠˆí¼ë°”ì´ì €ê°€ ì¶”ì¶œí•œ í‚¤ì›Œë“œ ëª©ë¡
            conversation_history: ì´ì „ ëŒ€í™” ë‚´ìš©
            
        Returns:
            ì‘ë‹µ ë° êµìœ¡ ì •ë³´ ì¹´ë“œ ì •ë³´
        """
        try:
            # ëŒ€í™” ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
            if conversation_history is None:
                conversation_history = []
                
            # í‚¤ì›Œë“œê°€ ì—†ëŠ” ê²½ìš° ì¿¼ë¦¬ì—ì„œ ì¶”ì¶œ
            if not keywords:
                extraction_response = await self.client.chat.completions.create(
                    model="gpt-4.1-mini",
                    messages=[
                        {"role": "system", "content": "ì‚¬ìš©ìì˜ ì§ˆë¬¸ì—ì„œ ì¥ì• ì¸ êµìœ¡ ì •ë³´ ê²€ìƒ‰ì— í•„ìš”í•œ í•µì‹¬ í‚¤ì›Œë“œë¥¼ 5ê°œ ì´ë‚´ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”."},
                        {"role": "user", "content": query}
                    ],
                    temperature=0.3
                )
                
                import json
                # ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²˜ë¦¬
                try:
                    keywords_data = json.loads(extraction_response.choices[0].message.content)
                    keywords = keywords_data.get("keywords", [])
                except json.JSONDecodeError:
                    # ì¼ë°˜ í…ìŠ¤íŠ¸ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œë„
                    content = extraction_response.choices[0].message.content
                    possible_keywords = [k.strip() for k in content.split(',')]
                    keywords = [k for k in possible_keywords if k]
            
            # êµìœ¡ ì •ë³´ ê²€ìƒ‰
            education_cards = await self.search_education_information(keywords)
            
            # ê²€ìƒ‰ ê²°ê³¼ ê¸°ë°˜ ì‘ë‹µ ìƒì„±
            service_titles = ", ".join([card["title"] for card in education_cards[:3]])
            
            # ëŒ€í™” ì´ë ¥ì„ LLM ë©”ì‹œì§€ë¡œ ë³€í™˜
            messages = [{"role": "system", "content": self._get_system_prompt()}]
            
            # ì´ì „ ëŒ€í™” ë‚´ìš©ì´ ìˆìœ¼ë©´ ë©”ì‹œì§€ì— ì¶”ê°€
            if conversation_history:
                for msg in conversation_history:
                    role = msg.get("role", "user")
                    content = msg.get("content", "")
                    if content.strip():  # ë‚´ìš©ì´ ìˆëŠ” ë©”ì‹œì§€ë§Œ ì¶”ê°€
                        messages.append({"role": role, "content": content})
            
            # ë§ˆì§€ë§‰ ì§ˆë¬¸ê³¼ êµìœ¡ ì •ë³´ í¬í•¨
            messages.append({
                "role": "user", 
                "content": f"ë‹¤ìŒ ì§ˆë¬¸ì— ëŒ€í•´ ê´€ë ¨ êµìœ¡ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”. ê´€ë ¨ ì„œë¹„ìŠ¤: {service_titles}\n\nì§ˆë¬¸: {query}"
            })
            
            response = await self.client.chat.completions.create(
                model="gpt-4.1-mini",
                messages=messages,
                temperature=0.7
            )
            
            answer = response.choices[0].message.content
            
            return {
                "answer": answer,
                "cards": education_cards
            }
            
        except Exception as e:
            logger.error(f"êµìœ¡ ì „ë¬¸ê°€ ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return {
                "answer": "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ êµìœ¡ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
                "cards": []
            }
    
    def _get_description(self) -> str:
        return "íŠ¹ìˆ˜êµìœ¡, í‰ìƒêµìœ¡, êµìœ¡ë¹„ ì§€ì› ì •ë³´ ì œê³µ"
    
    def _get_icon(self) -> str:
        return "ğŸ“"

async def education_response(query: str, keywords: List[str] = None, conversation_history=None) -> tuple:
    """
    êµìœ¡ ì „ë¬¸ê°€ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        query: ì‚¬ìš©ì ì¿¼ë¦¬
        keywords: í‚¤ì›Œë“œ ëª©ë¡
        conversation_history: ì´ì „ ëŒ€í™” ë‚´ìš©
        
    Returns:
        ì‘ë‹µ í…ìŠ¤íŠ¸ì™€ êµìœ¡ ì •ë³´ ì¹´ë“œ ëª©ë¡
    """
    expert = EducationExpert()
    response = await expert.process_query(query, keywords, conversation_history)
    return response["answer"], response["cards"] 