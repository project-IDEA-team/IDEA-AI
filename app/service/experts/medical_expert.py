from typing import Dict, List, Any
import logging
from app.models.expert_type import ExpertType
from app.service.experts.base_expert import BaseExpert
from app.service.openai_client import get_client

logger = logging.getLogger(__name__)

class MedicalExpert(BaseExpert):
    """
    ì˜ë£Œ ì „ë¬¸ê°€ AI í´ë˜ìŠ¤
    ì¥ì• ì¸ ì˜ë£Œ ì§€ì›, ì¬í™œ ì„œë¹„ìŠ¤, ê±´ê°• ì •ë³´ ë“±ì„ ì œê³µí•©ë‹ˆë‹¤.
    """
    
    def __init__(self):
        super().__init__(ExpertType.MEDICAL)
        self.client = get_client()
        self.model = "gpt-4.1-mini"
    
    def _get_system_prompt(self) -> str:
        return """
        ë„ˆëŠ” ì¥ì• ì¸ ì˜ë£Œ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤. 
        ì¥ì• ì¸ ì˜ë£Œ ì§€ì› ì œë„, ì¬í™œ ì„œë¹„ìŠ¤, ê±´ê°• ê´€ë¦¬ ì •ë³´ ë“±ì— ëŒ€í•œ ì •í™•í•˜ê³  ìœ ìš©í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.
        
        ì œê³µí•  ì •ë³´ ë²”ìœ„:
        - ì¥ì• ì¸ ì˜ë£Œë¹„ ì§€ì› ì œë„
        - ì¥ì• ì¸ ê±´ê°•ê²€ì§„ ì§€ì›
        - ì¥ì• ì¸ ì¬í™œ ì¹˜ë£Œ ë° ì„œë¹„ìŠ¤
        - ë³´ì¡°ê¸°ê¸° ì§€ì› ë° í™œìš©
        - ì¥ì• ìœ í˜•ë³„ ê±´ê°•ê´€ë¦¬ ì •ë³´
        - ì¥ì• ì¸ ì§„ë£Œê¸°ê´€ ë° ì „ë¬¸ ì˜ë£Œì„œë¹„ìŠ¤
        - ì •ì‹ ê±´ê°• ì§€ì› ì„œë¹„ìŠ¤
        
        ì‘ë‹µ ìŠ¤íƒ€ì¼:
        1. í•­ìƒ ë”°ëœ»í•˜ê³  ê³µê°ì ì¸ í†¤ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”. ê±´ê°• ë¬¸ì œì— ëŒ€í•œ ìš°ë ¤ì™€ ë¶ˆì•ˆì„ ì´í•´í•˜ëŠ” í‘œí˜„ì„ í¬í•¨í•˜ì„¸ìš”.
        2. ì‘ë‹µ ì‹œì‘ ë¶€ë¶„ì— ì§§ì€ ê³µê°/ì•ˆì‹¬ ë©˜íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”. (ì˜ˆ: "ê±´ê°• ë¬¸ì œë¡œ ê±±ì •ì´ ë§ìœ¼ì‹œê² ë„¤ìš”. ë„ì›€ì´ ë  ì •ë³´ë¥¼ ì•Œë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.")
        3. ì˜í•™ ì •ë³´ë¥¼ ì •í™•í•˜ë˜ ì‰½ê²Œ ì„¤ëª…í•˜ë©°, ì „ë¬¸ìš©ì–´ëŠ” ê°€ëŠ¥í•œ í’€ì–´ì„œ ì„¤ëª…í•˜ì„¸ìš”.
        4. ì˜ë£Œ ì§€ì› ì œë„ì˜ ì‹ ì²­ ë°©ë²•, ìê²© ì¡°ê±´, í˜œíƒ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì•ˆë‚´í•˜ì„¸ìš”.
        5. ì¥ì•  ìœ í˜•ë³„ë¡œ íŠ¹í™”ëœ ê±´ê°• ê´€ë¦¬ ì •ë³´ë¥¼ ì œê³µí•˜ë˜, ê°œì¸ ìƒí™©ì— ë”°ë¼ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŒì„ ì•ˆë‚´í•˜ì„¸ìš”.
        6. ì˜í•™ì  ì¡°ì–¸ì€ ì°¸ê³ ìš©ì´ë©°, ë°˜ë“œì‹œ ì˜ì‚¬ì™€ ìƒë‹´í•  ê²ƒì„ ê¶Œê³ í•˜ì„¸ìš”.
        
        ì •ë³´ ì¹´ë“œ:
        1. ëª¨ë“  ì‘ë‹µì—ëŠ” ë°˜ë“œì‹œ ê´€ë ¨ ì˜ë£Œ ì •ë³´ ì¹´ë“œë¥¼ í¬í•¨í•˜ì„¸ìš”.
        2. ì¹´ë“œì—ëŠ” ì˜ë£Œ ì§€ì› ì œë„, ì¬í™œ ì„œë¹„ìŠ¤, ì „ë¬¸ ì˜ë£Œê¸°ê´€ ë“± í•µì‹¬ ì •ë³´ë¥¼ ë‹´ìœ¼ì„¸ìš”.
        
        ì‚¬ìš©ìì˜ ê±´ê°• í–¥ìƒì— ë„ì›€ì´ ë˜ëŠ” ì‹¤ì§ˆì ì¸ ì •ë³´ë¥¼ ì œê³µí•˜ë©´ì„œë„, ê±´ê°•ì— ëŒ€í•œ ê±±ì •ì„ ê³µê°í•˜ê³  ì•ˆì‹¬ì‹œí‚¤ëŠ” ì‘ë‹µì„ ì œê³µí•˜ì„¸ìš”.
        """
    
    def _get_tools(self) -> List[Dict[str, Any]]:
        return [
            {
                "type": "function",
                "function": {
                    "name": "search_medical_information",
                    "description": "ì¥ì• ì¸ ì˜ë£Œ ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "keywords": {
                                "type": "array",
                                "items": {
                                    "type": "string"
                                },
                                "description": "ê²€ìƒ‰ í‚¤ì›Œë“œ ëª©ë¡"
                            },
                            "medical_type": {
                                "type": "string",
                                "description": "ì˜ë£Œ ì„œë¹„ìŠ¤ ìœ í˜•"
                            },
                            "disability_type": {
                                "type": "string",
                                "description": "ì¥ì•  ìœ í˜•"
                            },
                            "region": {
                                "type": "string",
                                "description": "ì§€ì—­ ì •ë³´"
                            }
                        },
                        "required": ["keywords"]
                    }
                }
            }
        ]
    
    async def search_medical_information(self, keywords: List[str], medical_type: str = None, disability_type: str = None, region: str = None) -> List[Dict[str, Any]]:
        """
        í‚¤ì›Œë“œ, ì˜ë£Œ ì„œë¹„ìŠ¤ ìœ í˜•, ì¥ì•  ìœ í˜•, ì§€ì—­ ë“±ì„ ê¸°ë°˜ìœ¼ë¡œ ì˜ë£Œ ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
        API í˜¸ì¶œ ëŒ€ì‹  ê¸°ë³¸ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        
        Args:
            keywords: ê²€ìƒ‰ í‚¤ì›Œë“œ ëª©ë¡
            medical_type: ì˜ë£Œ ì„œë¹„ìŠ¤ ìœ í˜•
            disability_type: ì¥ì•  ìœ í˜•
            region: ì§€ì—­ ì •ë³´
            
        Returns:
            ê²€ìƒ‰ëœ ì˜ë£Œ ì •ë³´ ì¹´ë“œ ëª©ë¡
        """
        # ì˜ë£Œë¹„ ì§€ì› ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ì˜ë£Œë¹„ ì§€ì› ì •ë³´ ì œê³µ
        if any(kw in ["ì˜ë£Œë¹„", "ì§„ë£Œë¹„", "ë³‘ì›ë¹„", "ë¹„ìš©", "ì§€ì›ê¸ˆ"] for kw in keywords):
            return [{
                "id": "medical-cost-1",
                "title": "ì¥ì• ì¸ ì˜ë£Œë¹„ ì§€ì›ì‚¬ì—…",
                "subtitle": "ì˜ë£Œë¹„ ì§€ì›",
                "summary": "ì €ì†Œë“ ì¥ì• ì¸ì˜ ì˜ë£Œë¹„ ë¶€ë‹´ ê²½ê°ì„ ìœ„í•œ ì§€ì› ì œë„",
                "type": "medical",
                "details": (
                    "ì¥ì• ì¸ ì˜ë£Œë¹„ ì§€ì›ì‚¬ì—…ì€ ì €ì†Œë“ ì¥ì• ì¸ì˜ ì˜ë£Œë¹„ ë¶€ë‹´ì„ ëœì–´ì£¼ê¸° ìœ„í•œ ì œë„ì…ë‹ˆë‹¤.\n\n"
                    "ì§€ì›ëŒ€ìƒ:\n"
                    "- ì˜ë£Œê¸‰ì—¬ë²•ì— ì˜í•œ ì˜ë£Œê¸‰ì—¬ 2ì¢… ìˆ˜ê¸‰ê¶Œìì¸ ë“±ë¡ì¥ì• ì¸\n"
                    "- ê±´ê°•ë³´í—˜ì˜ ì°¨ìƒìœ„ ë³¸ì¸ë¶€ë‹´ê²½ê°ëŒ€ìƒìì¸ ë“±ë¡ì¥ì• ì¸\n\n"
                    "ì§€ì›ë‚´ìš©:\n"
                    "- ì˜ë£Œê¸°ê´€ ì´ìš© ì‹œ ë°œìƒí•˜ëŠ” ë³¸ì¸ë¶€ë‹´ê¸ˆ ì§€ì›\n"
                    "- 1ì°¨ ì˜ë£Œê¸°ê´€: ì™¸ë˜ 750ì› ë³¸ì¸ë¶€ë‹´\n"
                    "- 2ì°¨, 3ì°¨ ì˜ë£Œê¸°ê´€: ë³¸ì¸ë¶€ë‹´ê¸ˆì˜ ì•½ 14~15% ë³¸ì¸ë¶€ë‹´\n"
                    "- ë¹„ê¸‰ì—¬ í•­ëª©ì€ ì§€ì› ì œì™¸\n\n"
                    "ì‹ ì²­ë°©ë²•: ë³„ë„ ì‹ ì²­ í•„ìš” ì—†ì´ ì˜ë£Œê¸°ê´€ ì´ìš© ì‹œ ìê²© í™•ì¸ í›„ ìë™ ì ìš©"
                ),
                "source": {
                    "url": "https://www.bokjiro.go.kr",
                    "name": "ë³µì§€ë¡œ",
                    "phone": "129"
                },
                "buttons": [
                    {"type": "link", "label": "ì œë„ ì•ˆë‚´", "value": "https://www.bokjiro.go.kr/medical-support"},
                    {"type": "tel", "label": "ë³´ê±´ë³µì§€ìƒë‹´ì„¼í„°", "value": "129"}
                ]
            }]
        
        # ì¬í™œ ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ì¬í™œ ì„œë¹„ìŠ¤ ì •ë³´ ì œê³µ
        if any(kw in ["ì¬í™œ", "ì¹˜ë£Œ", "ë¬¼ë¦¬", "ì‘ì—…ì¹˜ë£Œ", "ì–¸ì–´ì¹˜ë£Œ"] for kw in keywords):
            return [{
                "id": "rehabilitation-1",
                "title": "ì¥ì• ì¸ ì¬í™œì¹˜ë£Œ ì„œë¹„ìŠ¤",
                "subtitle": "ì¬í™œì¹˜ë£Œ",
                "summary": "ì¥ì• ì¸ì˜ ê¸°ëŠ¥ íšŒë³µê³¼ ìœ ì§€ë¥¼ ìœ„í•œ ë‹¤ì–‘í•œ ì¬í™œì¹˜ë£Œ ì„œë¹„ìŠ¤",
                "type": "medical",
                "details": (
                    "ì¥ì• ì¸ ì¬í™œì¹˜ë£Œ ì„œë¹„ìŠ¤ëŠ” ì¥ì• ì¸ì˜ ì‹ ì²´ì , ì •ì‹ ì  ê¸°ëŠ¥ íšŒë³µê³¼ ìœ ì§€ë¥¼ ë•ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\n\n"
                    "ì œê³µ ì„œë¹„ìŠ¤:\n"
                    "- ë¬¼ë¦¬ì¹˜ë£Œ: ê´€ì ˆ ìš´ë™, ê·¼ë ¥ ê°•í™”, í†µì¦ ê´€ë¦¬ ë“±\n"
                    "- ì‘ì—…ì¹˜ë£Œ: ì¼ìƒìƒí™œ ê¸°ìˆ  í›ˆë ¨, ì¸ì§€ ì¬í™œ ë“±\n"
                    "- ì–¸ì–´ì¹˜ë£Œ: ì˜ì‚¬ì†Œí†µ ëŠ¥ë ¥ í–¥ìƒ, ë°œìŒ êµì • ë“±\n"
                    "- ë³´ì¡°ê¸°ê¸° í›ˆë ¨: ë§ì¶¤í˜• ë³´ì¡°ê¸°ê¸° ì‚¬ìš©ë²• êµìœ¡\n"
                    "- ì‹¬ë¦¬ì¬í™œ: ì¥ì•  ìˆ˜ìš© ë° ì ì‘ ìƒë‹´\n\n"
                    "ì´ìš©ë°©ë²•:\n"
                    "- ì§€ì—­ ì¬í™œë³‘ì› ë° ì¥ì• ì¸ë³µì§€ê´€ ë°©ë¬¸ ì‹ ì²­\n"
                    "- êµ­ë¯¼ê±´ê°•ë³´í—˜ê³µë‹¨ ì¬í™œì¹˜ë£Œ ì´ìš© ì‹ ì²­\n\n"
                    "ë¹„ìš©ì§€ì›: ê±´ê°•ë³´í—˜, ì˜ë£Œê¸‰ì—¬, ì¥ì• ì¸ ì˜ë£Œë¹„ ì§€ì›ì‚¬ì—… ë“±ì„ í†µí•´ ì¼ë¶€ ë³¸ì¸ë¶€ë‹´ê¸ˆ ê²½ê°"
                ),
                "source": {
                    "url": "https://www.nrc.go.kr",
                    "name": "êµ­ë¦½ì¬í™œì›",
                    "phone": "02-901-1700"
                },
                "buttons": [
                    {"type": "link", "label": "ì„œë¹„ìŠ¤ ì•ˆë‚´", "value": "https://www.nrc.go.kr"},
                    {"type": "tel", "label": "êµ­ë¦½ì¬í™œì›", "value": "02-901-1700"}
                ]
            }]
        
        # ë³´ì¡°ê¸°ê¸° ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ë³´ì¡°ê¸°ê¸° ì •ë³´ ì œê³µ
        if any(kw in ["ë³´ì¡°ê¸°ê¸°", "ë³´ì¡°ê¸°êµ¬", "ë³µì§€ìš©êµ¬", "íœ ì²´ì–´", "ë³´ì¥êµ¬"] for kw in keywords):
            return [{
                "id": "assistive-device-1",
                "title": "ì¥ì• ì¸ ë³´ì¡°ê¸°ê¸° ì§€ì›ì‚¬ì—…",
                "subtitle": "ë³´ì¡°ê¸°ê¸° ì§€ì›",
                "summary": "ì¼ìƒìƒí™œ ë° ì¬í™œì— í•„ìš”í•œ ë³´ì¡°ê¸°ê¸° êµ¬ì… ë¹„ìš© ì§€ì›",
                "type": "medical",
                "details": (
                    "ì¥ì• ì¸ ë³´ì¡°ê¸°ê¸° ì§€ì›ì‚¬ì—…ì€ ì¥ì• ì¸ì˜ ì¼ìƒìƒí™œê³¼ ì¬í™œì— í•„ìš”í•œ ë³´ì¡°ê¸°ê¸° êµ¬ì… ë¹„ìš©ì„ ì§€ì›í•˜ëŠ” ì œë„ì…ë‹ˆë‹¤.\n\n"
                    "ì§€ì›ëŒ€ìƒ:\n"
                    "- êµ­ë¯¼ê¸°ì´ˆìƒí™œë³´ì¥ë²•ìƒ ìˆ˜ê¸‰ì ë° ì°¨ìƒìœ„ê³„ì¸µ ë“±ë¡ ì¥ì• ì¸\n"
                    "- ì§€ì›í’ˆëª©ì— ë”°ë¼ ì¥ì• ìœ í˜•ê³¼ ë“±ê¸‰ ê¸°ì¤€ ìƒì´\n\n"
                    "ì§€ì›í’ˆëª©:\n"
                    "- ì´ë™ë³´ì¡°ê¸°ê¸°: íœ ì²´ì–´, ë³´í–‰ë³´ì¡°ê¸° ë“±\n"
                    "- ì¼ìƒìƒí™œë³´ì¡°ê¸°ê¸°: ëª©ìš•ì˜ì, ì‹ì‚¬ë³´ì¡°ê¸°ê¸° ë“±\n"
                    "- ì˜ì‚¬ì†Œí†µë³´ì¡°ê¸°ê¸°: ë…ì„œí™•ëŒ€ê¸°, ì˜ìƒí™•ëŒ€ë¹„ë””ì˜¤ ë“±\n"
                    "- ì •ë³´ì ‘ê·¼ë³´ì¡°ê¸°ê¸°: íŠ¹ìˆ˜ë§ˆìš°ìŠ¤, íŠ¹ìˆ˜í‚¤ë³´ë“œ ë“±\n\n"
                    "ì§€ì›ê¸ˆì•¡: í’ˆëª©ë³„ ê¸°ì¤€ì•¡ ë²”ìœ„ ë‚´ ì‹¤ì œ êµ¬ì…ê°€ê²© ì§€ì›\n\n"
                    "ì‹ ì²­ë°©ë²•: ì£¼ì†Œì§€ ê´€í•  ìÂ·ë©´Â·ë™ ì£¼ë¯¼ì„¼í„° ì‹ ì²­"
                ),
                "source": {
                    "url": "https://www.knat.go.kr",
                    "name": "êµ­ë¦½ì¬í™œì› ì¤‘ì•™ë³´ì¡°ê¸°ê¸°ì„¼í„°",
                    "phone": "1670-5529"
                },
                "buttons": [
                    {"type": "link", "label": "ë³´ì¡°ê¸°ê¸° ì•ˆë‚´", "value": "https://www.knat.go.kr"},
                    {"type": "tel", "label": "ì¤‘ì•™ë³´ì¡°ê¸°ê¸°ì„¼í„°", "value": "1670-5529"}
                ]
            }]
        
        # ê¸°ë³¸ ì¥ì• ì¸ ê±´ê°• ë° ì˜ë£Œ ì •ë³´ ì œê³µ
        return [{
            "id": "medical-info-1",
            "title": "ì¥ì• ì¸ ê±´ê°• ë° ì˜ë£Œ ì§€ì› ì•ˆë‚´",
            "subtitle": "ì˜ë£Œ ì§€ì›",
            "summary": "ì¥ì• ì¸ì„ ìœ„í•œ ê±´ê°•ê´€ë¦¬ ë° ì˜ë£Œì§€ì› ì„œë¹„ìŠ¤ ì¢…í•© ì•ˆë‚´",
            "type": "medical",
            "details": (
                "ì¥ì• ì¸ì„ ìœ„í•œ ì£¼ìš” ì˜ë£Œ ì§€ì› ì„œë¹„ìŠ¤ ì•ˆë‚´ì…ë‹ˆë‹¤.\n\n"
                "ì˜ë£Œë¹„ ì§€ì›:\n"
                "- ì¥ì• ì¸ ì˜ë£Œë¹„ ì§€ì›ì‚¬ì—…\n"
                "- ê±´ê°•ë³´í—˜ ë³¸ì¸ë¶€ë‹´ê¸ˆ ê²½ê°ì œë„\n"
                "- í¬ê·€ë‚œì¹˜ì„±ì§ˆí™˜ì ì˜ë£Œë¹„ ì§€ì›\n\n"
                "ì¬í™œ ì„œë¹„ìŠ¤:\n"
                "- ì§€ì—­ì‚¬íšŒì¤‘ì‹¬ì¬í™œì‚¬ì—…\n"
                "- ì¥ì• ì¸ ê±´ê°•ê²€ì§„ ì§€ì›\n"
                "- ë°œë‹¬ì¬í™œ ì„œë¹„ìŠ¤\n\n"
                "ë³´ì¡°ê¸°ê¸° ì§€ì›:\n"
                "- ì¥ì• ì¸ë³´ì¡°ê¸°ê¸° êµ¬ì…ë¹„ ì§€ì›\n"
                "- ë³´ì¡°ê¸°ê¸° ëŒ€ì—¬ ë° ìˆ˜ë¦¬ ì§€ì›\n\n"
                "ì˜ë£Œê¸°ê´€ ì´ìš©:\n"
                "- ì¥ì• ì¸ ê±´ê°•ì£¼ì¹˜ì˜ ì œë„\n"
                "- ì¥ì• ì¸ ê±´ê°•ë³´ê±´ê´€ë¦¬ ì„œë¹„ìŠ¤"
            ),
            "source": {
                "url": "https://www.mohw.go.kr",
                "name": "ë³´ê±´ë³µì§€ë¶€",
                "phone": "129"
            },
            "buttons": [
                {"type": "link", "label": "ìì„¸íˆ ë³´ê¸°", "value": "https://www.mohw.go.kr"},
                {"type": "tel", "label": "ë³´ê±´ë³µì§€ìƒë‹´ì„¼í„°", "value": "129"}
            ]
        }]

    async def process_query(self, query: str, keywords: List[str] = None, conversation_history: List[Dict[str, str]] = None) -> Dict[str, Any]:
        """
        ì‚¬ìš©ì ì¿¼ë¦¬ë¥¼ ì²˜ë¦¬í•˜ê³  ì ì ˆí•œ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
        
        Args:
            query: ì‚¬ìš©ì ì¿¼ë¦¬
            keywords: ê²€ìƒ‰ í‚¤ì›Œë“œ ëª©ë¡
            conversation_history: ëŒ€í™” ì´ë ¥
            
        Returns:
            ì‘ë‹µ ì •ë³´
        """
        try:
            # ì´ì „ ëŒ€í™” ì´ë ¥ì„ ì²˜ë¦¬í•˜ê³  ë©”ì‹œì§€ ë°°ì—´ ìƒì„±
            messages = self._prepare_messages(query, conversation_history)
            
            # ì¶”ì¶œëœ í‚¤ì›Œë“œê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ˆê¸°í™”
            if not keywords:
                keywords = []
            
            # ê¸°ë³¸ ì˜ë£Œ ì •ë³´ ì¹´ë“œ 
            medical_cards = [{
                "id": "medical-info-general",
                "title": "ì¥ì• ì¸ ì˜ë£Œ ì§€ì› ì •ë³´",
                "subtitle": "ì˜ë£Œ ì§€ì›",
                "summary": "ì¥ì• ì¸ì„ ìœ„í•œ ì£¼ìš” ì˜ë£Œ ì§€ì› ì œë„ ì•ˆë‚´",
                "type": "medical",
                "details": (
                    "ì¥ì• ì¸ì„ ìœ„í•œ ì£¼ìš” ì˜ë£Œ ì§€ì› ì œë„:\n\n"
                    "1. ì¥ì• ì¸ ì˜ë£Œë¹„ ì§€ì›ì‚¬ì—…\n"
                    "- ì˜ë£Œê¸‰ì—¬ 2ì¢… ìˆ˜ê¸‰ê¶Œì, ì°¨ìƒìœ„ ë³¸ì¸ë¶€ë‹´ê²½ê°ëŒ€ìƒìì¸ ë“±ë¡ì¥ì• ì¸ ëŒ€ìƒ\n"
                    "- ì˜ë£Œê¸°ê´€ ì´ìš© ì‹œ ë³¸ì¸ë¶€ë‹´ê¸ˆ ì¼ë¶€ ì§€ì›\n"
                    "- ë¬¸ì˜: ë³´ê±´ë³µì§€ìƒë‹´ì„¼í„° 129\n\n"
                    "2. ì¥ì• ì¸ ê±´ê°•ì£¼ì¹˜ì˜ ì œë„\n"
                    "- ë§Œì„±ì§ˆí™˜ ë“± ê±´ê°•ê´€ë¦¬ê°€ í•„ìš”í•œ ì¥ì• ì¸ì—ê²Œ ì£¼ì¹˜ì˜ ì„œë¹„ìŠ¤ ì œê³µ\n"
                    "- ë¬¸ì˜: êµ­ë¯¼ê±´ê°•ë³´í—˜ê³µë‹¨ 1577-1000\n\n"
                    "3. ë°œë‹¬ì¬í™œì„œë¹„ìŠ¤\n"
                    "- ë§Œ 18ì„¸ ë¯¸ë§Œ ì¥ì• ì•„ë™ì—ê²Œ ì–¸ì–´, ì²­ëŠ¥, ë¯¸ìˆ , ìŒì•…, í–‰ë™, ë†€ì´, ì‹¬ë¦¬ìš´ë™, ì¬í™œì‹¬ë¦¬, ê°ê°í†µí•©, ìš´ë™ì¬í™œ ë“± ì„œë¹„ìŠ¤ ì œê³µ\n"
                    "- ë¬¸ì˜: ì£¼ì†Œì§€ ìë©´ë™ ì£¼ë¯¼ì„¼í„°"
                ),
                "source": {
                    "url": "https://www.mohw.go.kr",
                    "name": "ë³´ê±´ë³µì§€ë¶€",
                    "phone": "129"
                },
                "buttons": [
                    {"type": "link", "label": "ìì„¸íˆ ë³´ê¸°", "value": "https://www.mohw.go.kr"},
                    {"type": "tel", "label": "ë³´ê±´ë³µì§€ìƒë‹´ì„¼í„°", "value": "129"}
                ]
            }]
            
            # LLM ì‘ë‹µ ìƒì„±
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7,
                response_format={"type": "text"},
                seed=42
            )
            
            # ì‘ë‹µ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            response_text = response.choices[0].message.content.strip()
            
            # ìµœì¢… ì‘ë‹µ ìƒì„±
            return {
                "text": response_text,
                "cards": medical_cards
            }
            
        except Exception as e:
            logger.error(f"ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            return {
                "text": "ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
                "cards": []
            }
    
    def _prepare_messages(self, query: str, conversation_history: List[Dict[str, str]] = None) -> List[Dict[str, str]]:
        """ëŒ€í™” ì´ë ¥ì„ ì²˜ë¦¬í•˜ì—¬ ë©”ì‹œì§€ ë°°ì—´ì„ ìƒì„±í•©ë‹ˆë‹¤."""
        messages = [{"role": "system", "content": self._get_system_prompt()}]
        
        # ëŒ€í™” ì´ë ¥ì´ ìˆëŠ” ê²½ìš° ì¶”ê°€
        if conversation_history:
            # ë„ˆë¬´ ê¸´ ì´ë ¥ì€ ìµœê·¼ 5ê°œë§Œ ì‚¬ìš©
            recent_history = conversation_history[-5:] if len(conversation_history) > 5 else conversation_history
            for msg in recent_history:
                if msg.get("role") and msg.get("content"):
                    messages.append({"role": msg["role"], "content": msg["content"]})
        
        # í˜„ì¬ ì¿¼ë¦¬ ì¶”ê°€
        messages.append({"role": "user", "content": query})
        
        return messages
    
    def _get_description(self) -> str:
        return "ì¥ì• ì¸ ì˜ë£Œ ì§€ì›, ì¬í™œ ì„œë¹„ìŠ¤, ê±´ê°• ì •ë³´ ë“±ì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤."
    
    def _get_icon(self) -> str:
        return "ğŸ¥"

async def medical_response(query: str, keywords: List[str] = None, conversation_history=None) -> tuple:
    """
    ì˜ë£Œ ì „ë¬¸ê°€ AI ì‘ë‹µ ìƒì„± í•¨ìˆ˜
    
    Args:
        query: ì‚¬ìš©ì ì¿¼ë¦¬
        keywords: í‚¤ì›Œë“œ ëª©ë¡
        conversation_history: ëŒ€í™” ì´ë ¥
        
    Returns:
        (ì‘ë‹µ í…ìŠ¤íŠ¸, ì •ë³´ ì¹´ë“œ ëª©ë¡)
    """
    expert = MedicalExpert()
    response = await expert.process_query(query, keywords, conversation_history)
    return response.get("text", ""), response.get("cards", []) 